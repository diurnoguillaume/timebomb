<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Bomb - Victorian Cyberpunk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Space+Mono:wght@400;700&display=swap');
      
      :root {
        --color-sherlock: #3b82f6;
        --color-moriarty: #ef4444;
      }

      body {
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: 'Space Mono', monospace;
        overflow-x: hidden;
      }

      /* ROLE BASED VIGNETTES */
      .vignette-sherlock { background: radial-gradient(circle, transparent 20%, rgba(15,23,42,0.8) 80%, #0f172a 100%), linear-gradient(rgba(59,130,246,0.05) 1px, transparent 1px); background-size: 100% 100%, 20px 20px; }
      .vignette-moriarty { background: radial-gradient(circle, transparent 20%, rgba(15,23,42,0.8) 80%, #000 100%), linear-gradient(rgba(239,68,68,0.05) 1px, transparent 1px); background-size: 100% 100%, 20px 20px; }

      /* TENSION ANIMATIONS */
      @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-2px, 1px); } 50% { transform: translate(2px, -1px); } 75% { transform: translate(-1px, -2px); } }
      .wire-tension { animation: shake 0.1s infinite; }
      
      .dossier-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255,255,255,0.1);
      }
      .active-turn-glow { box-shadow: 0 0 25px rgba(234, 179, 8, 0.3); border-color: rgba(234, 179, 8, 0.5); }
      
      /* Progress Bar for Hold-to-Cut */
      .cut-progress { position: absolute; bottom: 0; left: 0; width: 100%; background: white; mix-blend-mode: overlay; transition: height 0.1s linear; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      // --- CONFIG & UTILS (PRESERVED) ---
      const firebaseConfig = {
        apiKey: "AIzaSyDAI46UYQMVMCnNqQD9MqR3yhiHUzghYuA",
        authDomain: "timebomb-game.firebaseapp.com",
        databaseURL: "https://timebomb-game-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "timebomb-game",
        storageBucket: "timebomb-game.firebasestorage.app",
        messagingSenderId: "752842528482",
        appId: "1:752842528482:web:f97dd6bead7bb6bca4f0bb",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const GAME_CONFIG = {
        4: { sherlock: 3, moriarty: 2, wires: 15, defusing: 4, bomb: 1 },
        5: { sherlock: 3, moriarty: 2, wires: 19, defusing: 5, bomb: 1 },
        6: { sherlock: 4, moriarty: 2, wires: 23, defusing: 6, bomb: 1 },
        7: { sherlock: 5, moriarty: 3, wires: 27, defusing: 7, bomb: 1 },
        8: { sherlock: 5, moriarty: 3, wires: 31, defusing: 8, bomb: 1 },
      };

      const { useState, useEffect, useRef, createElement: h } = React;

      // --- NEW ICONS ---
      const IconWire = () => h("svg", { className: "w-4 h-4", fill: "currentColor", viewBox: "0 0 24 24" }, h("path", { d: "M12 2v20M8 6h8M8 18h8" }));
      const IconShield = () => h("svg", { className: "w-6 h-6 text-blue-400", fill: "none", stroke: "currentColor", strokeWidth: "2", viewBox: "0 0 24 24" }, h("path", { d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" }));
      const IconBomb = () => h("svg", { className: "w-6 h-6 text-red-500", fill: "none", stroke: "currentColor", strokeWidth: "2", viewBox: "0 0 24 24" }, h("circle", { cx: "11", cy: "13", r: "9" }), h("path", { d: "M18.35 5.65L19 5M12 9v4M12 17h.01" }));

      // ==========================================
      // GAME SCREEN (REFACTORED UI)
      // ==========================================

      function Wire({ wire, canCut, onCut }) {
        const [holdTime, setHoldTime] = useState(0);
        const timerRef = useRef(null);

        const startHold = () => {
          if (!canCut || wire.revealed) return;
          timerRef.current = setInterval(() => {
            setHoldTime(prev => {
              if (prev >= 100) {
                clearInterval(timerRef.current);
                onCut();
                return 0;
              }
              return prev + 5;
            });
          }, 50);
        };

        const endHold = () => {
          clearInterval(timerRef.current);
          setHoldTime(0);
        };

        const isSafe = wire.type === 'safe';
        const isDefuse = wire.type === 'defusing';
        const isBomb = wire.type === 'bomb';

        return h("div", {
          className: `relative w-8 h-24 mx-1 rounded-full border-2 transition-all cursor-pointer overflow-hidden
            ${wire.revealed ? 'border-transparent' : 'border-slate-500 hover:border-amber-400'}
            ${holdTime > 0 ? 'wire-tension' : ''}`,
          onMouseDown: startHold, onMouseUp: endHold, onMouseLeave: endHold,
          onTouchStart: startHold, onTouchEnd: endHold
        },
          !wire.revealed && h("div", { className: "w-full h-full bg-slate-700 flex flex-col items-center justify-between py-2" },
            h("div", { className: "w-2 h-2 rounded-full bg-slate-400" }),
            h("div", { className: "w-1 h-12 bg-amber-600/50" }),
            h("div", { className: "w-2 h-2 rounded-full bg-slate-400" }),
            h("div", { className: "cut-progress", style: { height: `${holdTime}%` } })
          ),
          wire.revealed && h("div", { className: `w-full h-full flex items-center justify-center text-xl
            ${isDefuse ? 'bg-blue-600' : isBomb ? 'bg-red-600' : 'bg-slate-800 opacity-20'}` },
            isDefuse ? "âœ‚ï¸" : isBomb ? "ðŸ’£" : ""
          )
        );
      }

      function GameScreen({ gameState, playerId, myRole, cutWire }) {
        const currentPlayer = gameState.players[gameState.currentPlayer];
        const isMyTurn = currentPlayer.id === playerId;
        const myPlayer = gameState.players.find(p => p.id === playerId);
        const [showRoleInfo, setShowRoleInfo] = useState(false);

        // Calculate progress
        const defusingTotal = gameState.config.defusing;
        const defusingFound = gameState.defusingFound || 0;
        const cutsLeft = gameState.playerCount - (gameState.revealedInRound || 0);

        return h("div", { className: `min-h-screen ${myRole === 'sherlock' ? 'vignette-sherlock' : 'vignette-moriarty'}` },
          // --- TOP HUD ---
          h("div", { className: "fixed top-0 left-0 w-full z-40 bg-slate-900/80 border-b border-white/10 backdrop-blur-md p-4 flex justify-between items-center" },
            h("div", { className: "flex items-center gap-4" },
              h("div", { className: "h-3 w-32 bg-slate-800 rounded-full overflow-hidden border border-white/10" },
                h("div", { className: "h-full bg-blue-500 transition-all duration-500", style: { width: `${(defusingFound/defusingTotal)*100}%`} })
              ),
              h("span", { className: "text-xs font-bold text-blue-400" }, `${defusingFound}/${defusingTotal} DEFUSED`)
            ),
            h("div", { className: "flex flex-col items-center" },
              h("span", { className: "text-[10px] text-slate-500 font-bold uppercase" }, "Round"),
              h("span", { className: "text-2xl font-bold text-amber-500 leading-none" }, gameState.round)
            ),
            h("div", { className: "text-right" },
              h("span", { className: "text-[10px] text-slate-500 font-bold uppercase block" }, "Cuts Left"),
              h("span", { className: "text-xl font-bold text-red-500" }, cutsLeft)
            )
          ),

          // --- ACTION BANNER ---
          h("div", { className: "pt-24 px-4 max-w-4xl mx-auto" },
            h("div", { className: `p-4 rounded-xl text-center border transition-all ${isMyTurn ? 'bg-amber-900/40 border-amber-500 animate-pulse' : 'bg-slate-800/40 border-slate-700'}` },
              h("h2", { className: `text-lg font-bold ${isMyTurn ? 'text-amber-400' : 'text-slate-300'}` },
                isMyTurn ? "âœ‚ï¸ YOUR TURN: SNIP A WIRE" : `WAITING FOR ${currentPlayer.name.toUpperCase()}...`
              )
            )
          ),

          // --- PLAYERS GRID ---
          h("div", { className: "p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto pb-40" },
            gameState.players.map((p) => {
              const isTurn = p.id === currentPlayer.id;
              const isMe = p.id === playerId;
              const announcement = gameState.announcements ? gameState.announcements[p.id] : null;

              return h("div", { key: p.id, className: `dossier-card rounded-2xl p-4 relative ${isTurn ? 'active-turn-glow' : ''}` },
                // Header
                h("div", { className: "flex justify-between items-start mb-4" },
                  h("div", null,
                    h("h3", { className: `font-bold ${isMe ? 'text-blue-400' : 'text-white'}` }, p.name + (isMe ? " (YOU)" : "")),
                    isTurn && h("span", { className: "text-[10px] bg-amber-500 text-black px-1 font-bold" }, "ACTIVE")
                  ),
                  announcement && h("div", { className: "bg-white/10 px-2 py-1 rounded text-[10px] border border-white/20" },
                    h("span", { className: "text-blue-400 mr-2" }, `âœ‚ï¸ ${announcement.defusing}`),
                    h("span", { className: "text-red-400" }, `ðŸ’£ ${announcement.bomb}`)
                  )
                ),
                // Wires Hand
                h("div", { className: "flex justify-center" },
                  p.wires.map(w => h(Wire, { key: w.id, wire: w, canCut: isMyTurn && !isMe, onCut: () => cutWire(p.id, w.id) }))
                )
              );
            })
          ),

          // --- BOTTOM ROLE DOCK ---
          h("div", { className: "fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-slate-950 to-transparent flex justify-center pointer-events-none" },
            h("div", { 
              className: `pointer-events-auto cursor-pointer flex items-center gap-4 px-6 py-3 rounded-full border-2 bg-slate-900 transition-all hover:scale-105 shadow-2xl
                ${myRole === 'sherlock' ? 'border-blue-500 shadow-blue-500/20' : 'border-red-500 shadow-red-500/20'}`,
              onClick: () => setShowRoleInfo(!showRoleInfo)
            },
              myRole === 'sherlock' ? h(IconShield) : h(IconBomb),
              h("div", null,
                h("div", { className: "text-[10px] text-slate-400 font-bold uppercase leading-none" }, "Your Identity"),
                h("div", { className: "text-sm font-bold tracking-widest" }, myRole.toUpperCase())
              )
            )
          ),

          // --- ROLE HELP MODAL ---
          showRoleInfo && h("div", { className: "fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm", onClick: () => setShowRoleInfo(false) },
            h("div", { className: "bg-slate-900 border-2 border-white/20 p-8 rounded-3xl max-w-sm text-center shadow-2xl", onClick: e => e.stopPropagation() },
              myRole === 'sherlock' ? h(IconShield) : h(IconBomb),
              h("h2", { className: "text-2xl font-bold my-4 uppercase tracking-tighter" }, myRole),
              h("p", { className: "text-slate-400 text-sm leading-relaxed mb-6" }, 
                myRole === 'sherlock' 
                  ? "You must collaborate with your agents to find all the defusing wires before time runs out. Be carefulâ€”Moriarty is hiding among you."
                  : "You must prevent Sherlock from finding the wires. Lie about your hand to lead them to the bomb or stall until the end of Round 4."
              ),
              h("button", { className: "w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all", onClick: () => setShowRoleInfo(false) }, "UNDERSTOOD")
            )
          )
        );
      }

      // ==========================================
      // LOBBY, HOME & END SCREENS (RE-STYLING WHILE PRESERVING ALL LOGIC)
      // ==========================================

      function HomeScreen({ playerName, setPlayerName, inputCode, setInputCode, error, loading, createRoom, joinRoom }) {
        return h("div", { className: "min-h-screen flex items-center justify-center p-6" },
          h("div", { className: "max-w-md w-full bg-slate-900 border border-white/10 p-8 rounded-3xl shadow-2xl" },
            h("h1", { className: "text-4xl font-bold text-center mb-8 tracking-tighter" }, "TIME BOMB"),
            h("div", { className: "space-y-4" },
              h("input", { type: "text", placeholder: "PLAYER NAME", value: playerName, onChange: e => setPlayerName(e.target.value.toUpperCase()), className: "w-full bg-slate-800 border-none p-4 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none font-bold" }),
              error && h("p", { className: "text-red-500 text-xs text-center" }, error),
              h("button", { onClick: createRoom, disabled: loading, className: "w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold shadow-lg shadow-blue-600/20" }, "CREATE SECRET ROOM"),
              h("div", { className: "flex items-center gap-4 py-2" }, h("hr", { className: "flex-1 opacity-10" }), h("span", { className: "text-[10px] text-slate-500" }, "OR"), h("hr", { className: "flex-1 opacity-10" })),
              h("input", { type: "text", placeholder: "ROOM CODE", value: inputCode, onChange: e => setInputCode(e.target.value.toUpperCase()), className: "w-full bg-slate-800 border-none p-4 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none font-bold text-center tracking-[10px]" }),
              h("button", { onClick: joinRoom, disabled: loading, className: "w-full bg-slate-700 hover:bg-slate-600 py-4 rounded-xl font-bold" }, "JOIN OPERATION")
            )
          )
        );
      }

      function LobbyScreen({ roomCode, playerId, gameState, updatePlayerCount, toggleReady, startGame }) {
        const isHost = playerId === gameState.hostId;
        const me = gameState.players.find(p => p.id === playerId);
        const allReady = gameState.players.length >= 4 && gameState.players.every(p => p.ready);

        return h("div", { className: "min-h-screen p-6 max-w-2xl mx-auto" },
          h("div", { className: "text-center mb-12" },
            h("span", { className: "text-[10px] text-slate-500 font-bold uppercase" }, "Room Code"),
            h("h2", { className: "text-5xl font-bold tracking-[15px] text-amber-500" }, roomCode)
          ),
          isHost && h("div", { className: "mb-8 bg-slate-900 p-6 rounded-2xl border border-white/10" },
            h("p", { className: "text-xs font-bold text-slate-500 mb-4 uppercase" }, "Mission Parameters: Player Count"),
            h("div", { className: "flex gap-2" }, [4,5,6,7,8].map(n => 
              h("button", { key: n, onClick: () => updatePlayerCount(n), className: `flex-1 py-3 rounded-lg font-bold transition-all ${gameState.playerCount === n ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}` }, n)
            ))
          ),
          h("div", { className: "space-y-3 mb-12" }, 
            gameState.players.map(p => 
              h("div", { key: p.id, className: "flex justify-between items-center bg-slate-900 p-4 rounded-xl border border-white/5" },
                h("span", { className: "font-bold" }, p.name + (p.id === gameState.hostId ? " (HOST)" : "")),
                h("span", { className: `text-[10px] font-bold px-2 py-1 rounded ${p.ready ? 'bg-green-500 text-black' : 'bg-slate-800 text-slate-500'}` }, p.ready ? "READY" : "WAITING")
              )
            )
          ),
          h("div", { className: "fixed bottom-0 left-0 w-full p-6 flex gap-4 bg-gradient-to-t from-slate-950" },
            h("button", { onClick: toggleReady, className: `flex-1 py-4 rounded-2xl font-bold transition-all ${me.ready ? 'bg-slate-700' : 'bg-green-600 hover:bg-green-500'}` }, me.ready ? "CANCEL READY" : "READY UP"),
            isHost && h("button", { onClick: startGame, disabled: !allReady, className: "flex-1 bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold disabled:opacity-30 disabled:grayscale" }, "INITIATE GAME")
          )
        );
      }

      function EndScreen({ gameState, myRole, playerId, playAgain, leaveRoom }) {
        const win = gameState.winner === myRole;
        return h("div", { className: "min-h-screen flex items-center justify-center p-6 text-center" },
          h("div", null,
            h("h1", { className: `text-6xl font-bold mb-2 tracking-tighter ${win ? 'text-green-500' : 'text-red-500'}` }, win ? "VICTORY" : "DEFEAT"),
            h("p", { className: "text-slate-400 mb-8 font-bold" }, gameState.winner === 'sherlock' ? "The bomb was defused." : "London has fallen."),
            h("div", { className: "flex gap-4 justify-center" },
              playerId === gameState.hostId && h("button", { onClick: playAgain, className: "px-8 py-4 bg-blue-600 rounded-xl font-bold" }, "PLAY AGAIN"),
              h("button", { onClick: leaveRoom, className: "px-8 py-4 bg-slate-800 rounded-xl font-bold" }, "EXIT")
            )
          )
        );
      }

      // ==========================================
      // MAIN APP LOGIC (PRESERVED & INTEGRATED)
      // ==========================================

      function TimeBombApp() {
        const [screen, setScreen] = useState("home");
        const [playerName, setPlayerName] = useState("");
        const [roomCode, setRoomCode] = useState("");
        const [inputCode, setInputCode] = useState("");
        const [playerId, setPlayerId] = useState(null);
        const [gameState, setGameState] = useState(null);
        const [myRole, setMyRole] = useState(null);
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

        // Firebase Sync
        useEffect(() => {
          if (!roomCode) return;
          const ref = database.ref(`rooms/${roomCode}`);
          ref.on("value", (snap) => {
            const data = snap.val();
            if (!data) return;
            setGameState(data);
            if (data.status === "lobby") setScreen("lobby");
            if (data.status === "playing") {
              setScreen("game");
              const me = data.players.find(p => p.id === playerId);
              if (me) setMyRole(me.role);
            }
            if (data.status === "ended") setScreen("end");
          });
          return () => ref.off();
        }, [roomCode, playerId]);

        const createRoom = async () => {
          if (!playerName) return setError("NAME REQUIRED");
          setLoading(true);
          const code = Math.random().toString(36).substring(2, 7).toUpperCase();
          const initial = {
            code, status: "lobby", hostId: 0, playerCount: 5,
            players: [{ id: 0, name: playerName, ready: false }],
            createdAt: Date.now()
          };
          await database.ref(`rooms/${code}`).set(initial);
          setPlayerId(0); setRoomCode(code); setLoading(false);
        };

        const joinRoom = async () => {
          if (!playerName || !inputCode) return setError("NAME & CODE REQUIRED");
          setLoading(true);
          const snap = await database.ref(`rooms/${inputCode}`).once("value");
          if (!snap.exists()) { setLoading(false); return setError("ROOM NOT FOUND"); }
          const data = snap.val();
          if (data.status !== "lobby") { setLoading(false); return setError("GAME IN PROGRESS"); }
          const nextId = Math.max(...data.players.map(p => p.id)) + 1;
          const newPlayers = [...data.players, { id: nextId, name: playerName, ready: false }];
          await database.ref(`rooms/${inputCode}/players`).set(newPlayers);
          setPlayerId(nextId); setRoomCode(inputCode); setLoading(false);
        };

        const updatePlayerCount = (n) => database.ref(`rooms/${roomCode}/playerCount`).set(n);
        
        const toggleReady = () => {
          const idx = gameState.players.findIndex(p => p.id === playerId);
          database.ref(`rooms/${roomCode}/players/${idx}/ready`).set(!gameState.players[idx].ready);
        };

        const startGame = async () => {
          const config = GAME_CONFIG[gameState.playerCount];
          const roles = [...Array(config.sherlock).fill("sherlock"), ...Array(config.moriarty).fill("moriarty")].sort(() => Math.random() - 0.5);
          const wires = [...Array(config.defusing).fill("defusing"), ...Array(config.bomb).fill("bomb"), ...Array(config.wires).fill("safe")].sort(() => Math.random() - 0.5);
          
          const players = gameState.players.map((p, i) => ({
            ...p, role: roles[i],
            wires: wires.slice(i*5, (i+1)*5).map((t, wi) => ({ id: `${p.id}-${wi}`, type: t, revealed: false }))
          }));

          await database.ref(`rooms/${roomCode}`).update({
            status: "playing", players, config, round: 1, defusingFound: 0, revealedInRound: 0,
            currentPlayer: Math.floor(Math.random() * players.length)
          });
        };

        const cutWire = async (targetId, wireId) => {
          const newState = JSON.parse(JSON.stringify(gameState));
          const target = newState.players.find(p => p.id === targetId);
          const wire = target.wires.find(w => w.id === wireId);
          
          wire.revealed = true;
          if (wire.type === 'bomb') { newState.status = 'ended'; newState.winner = 'moriarty'; }
          else if (wire.type === 'defusing') {
            newState.defusingFound++;
            if (newState.defusingFound === newState.config.defusing) { newState.status = 'ended'; newState.winner = 'sherlock'; }
          }

          if (newState.status === 'playing') {
            newState.revealedInRound++;
            newState.currentPlayer = newState.players.findIndex(p => p.id === targetId);
            
            if (newState.revealedInRound === newState.playerCount) {
              if (newState.round === 4) { newState.status = 'ended'; newState.winner = 'moriarty'; }
              else {
                // Shuffle unrevealed wires
                const remaining = newState.players.flatMap(p => p.wires.filter(w => !w.revealed).map(w => w.type)).sort(() => Math.random() - 0.5);
                const perPlayer = remaining.length / newState.playerCount;
                newState.players.forEach((p, i) => {
                  p.wires = remaining.slice(i * perPlayer, (i + 1) * perPlayer).map((t, wi) => ({ id: `${p.id}-${newState.round}-${wi}`, type: t, revealed: false }));
                });
                newState.round++;
                newState.revealedInRound = 0;
                newState.announcements = {};
              }
            }
          }
          await database.ref(`rooms/${roomCode}`).set(newState);
        };

        if (screen === "home") return h(HomeScreen, { playerName, setPlayerName, inputCode, setInputCode, error, loading, createRoom, joinRoom });
        if (screen === "lobby") return h(LobbyScreen, { roomCode, playerId, gameState, updatePlayerCount, toggleReady, startGame });
        if (screen === "game") return h(GameScreen, { gameState, playerId, myRole, cutWire });
        if (screen === "end") return h(EndScreen, { gameState, myRole, playerId, playAgain: startGame, leaveRoom: () => location.reload() });
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(h(TimeBombApp));
    </script>
  </body>
</html>