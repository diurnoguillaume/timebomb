<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Bomb - Multiplayer Game</title>
    <meta
      name="description"
      content="Time Bomb - A thrilling online multiplayer deduction game."
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              serif: ['"Courier Prime"', "Courier", "serif"],
              sans: [
                "-apple-system",
                "BlinkMacSystemFont",
                "Segoe UI",
                "Roboto",
                "sans-serif",
              ],
            },
            animation: {
              "pulse-fast": "pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              shake: "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
            },
            keyframes: {
              shake: {
                "10%, 90%": { transform: "translate3d(-1px, 0, 0)" },
                "20%, 80%": { transform: "translate3d(2px, 0, 0)" },
                "30%, 50%, 70%": { transform: "translate3d(-4px, 0, 0)" },
                "40%, 60%": { transform: "translate3d(4px, 0, 0)" },
              },
            },
          },
        },
      };
    </script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }

      /* --- NEW VISUAL EFFECTS FOR GAME SCREEN --- */
      .vignette-sherlock {
        background: radial-gradient(
          circle at center,
          transparent 0%,
          rgba(15, 23, 42, 0.4) 60%,
          rgba(15, 23, 42, 0.95) 100%
        );
      }
      .vignette-moriarty {
        background: radial-gradient(
          circle at center,
          transparent 0%,
          rgba(69, 10, 10, 0.2) 60%,
          rgba(0, 0, 0, 0.95) 100%
        );
        animation: breathe 4s infinite ease-in-out;
      }
      @keyframes breathe {
        0%, 100% { box-shadow: inset 0 0 50px rgba(220, 38, 38, 0.1); }
        50% { box-shadow: inset 0 0 100px rgba(220, 38, 38, 0.3); }
      }
      .wire-tension {
        animation: wire-shake 0.1s infinite;
      }
      @keyframes wire-shake {
        0% { transform: translateX(0px) scaleY(1); }
        25% { transform: translateX(1px) scaleY(1.02); }
        50% { transform: translateX(0px) scaleY(1); }
        75% { transform: translateX(-1px) scaleY(1.02); }
        100% { transform: translateX(0px) scaleY(1); }
      }
      
      /* --- KEEPING YOUR ORIGINAL ANIMATIONS FOR COMPATIBILITY --- */
      @keyframes fadeInScale { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
      @keyframes popupSlideIn { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
      .announcement-popup {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        animation: popupSlideIn 0.3s ease-out forwards; z-index: 60;
      }
      .announcement-backdrop {
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 55;
        animation: fadeInScale 0.2s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      // ==========================================
      // FIREBASE CONFIGURATION (YOUR ORIGINAL)
      // ==========================================
      const firebaseConfig = {
        apiKey: "AIzaSyDAI46UYQMVMCnNqQD9MqR3yhiHUzghYuA",
        authDomain: "timebomb-game.firebaseapp.com",
        databaseURL: "https://timebomb-game-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "timebomb-game",
        storageBucket: "timebomb-game.firebasestorage.app",
        messagingSenderId: "752842528482",
        appId: "1:752842528482:web:f97dd6bead7bb6bca4f0bb",
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // ==========================================
      // GAME CONFIGURATION (YOUR ORIGINAL)
      // ==========================================
      const GAME_CONFIG = {
        4: { sherlock: 3, moriarty: 2, wires: 15, defusing: 4, bomb: 1 },
        5: { sherlock: 3, moriarty: 2, wires: 19, defusing: 5, bomb: 1 },
        6: { sherlock: 4, moriarty: 2, wires: 23, defusing: 6, bomb: 1 },
        7: { sherlock: 5, moriarty: 3, wires: 27, defusing: 7, bomb: 1 },
        8: { sherlock: 5, moriarty: 3, wires: 31, defusing: 8, bomb: 1 },
      };

      const generateRoomCode = () => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let code = "";
        for (let i = 0; i < 5; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      };

      // ==========================================
      // COMPONENTS
      // ==========================================
      const { useState, useEffect, useRef, createElement: h } = React;

      // --- HELPER ICONS (Simplified for new design) ---
      const IconScissors = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("circle", { cx: "6", cy: "6", r: "3" }), h("path", { d: "M8.12 8.12 12 12" }), h("path", { d: "M20 4 8.12 15.88" }), h("circle", { cx: "6", cy: "18", r: "3" }), h("path", { d: "M14.8 14.8 20 20" }));
      const IconBomb = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("circle", { cx: "11", cy: "13", r: "9" }), h("path", { d: "M14.35 4.65 16.3 2.7a2.41 2.41 0 0 1 3.4 0l1.6 1.6a2.4 2.4 0 0 1 0 3.4l-1.95 1.95" }), h("path", { d: "m22 2-1.5 1.5" }));
      const IconShield = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("path", { d: "M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" }));
      const IconEye = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("path", { d: "M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" }), h("circle", { cx: "12", cy: "12", r: "3" }));
      const IconUsers = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("path", { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), h("circle", { cx: "9", cy: "7", r: "4" }), h("path", { d: "M22 21v-2a4 4 0 0 0-3-3.87" }), h("path", { d: "M16 3.13a4 4 0 0 1 0 7.75" }));
      const IconTimer = (props) => h("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, h("line", { x1: "12", x2: "12", y1: "2", y2: "6" }), h("line", { x1: "12", x2: "12", y1: "18", y2: "22" }), h("line", { x1: "4.93", x2: "7.76", y1: "4.93", y2: "7.76" }), h("line", { x1: "16.24", x2: "19.07", y1: "16.24", y2: "19.07" }), h("line", { x1: "2", x2: "6", y1: "12", y2: "12" }), h("line", { x1: "18", x2: "22", y1: "12", y2: "12" }), h("line", { x1: "4.93", x2: "7.76", y1: "19.07", y2: "16.24" }), h("line", { x1: "16.24", x2: "19.07", y1: "7.76", y2: "4.93" }));

      // ==========================================
      // YOUR ORIGINAL SCREENS (Home, Lobby, End)
      // ==========================================

      function HomeScreen({ playerName, setPlayerName, inputCode, setInputCode, error, loading, createRoom, joinRoom }) {
        return h("div", { className: "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4" },
          h("div", { className: "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-slate-700" },
            h("div", { className: "text-center mb-8" },
              h(IconTimer, { className: "w-16 h-16 mx-auto mb-4 text-yellow-400" }),
              h("h1", { className: "text-4xl font-bold text-white mb-2" }, "Time Bomb"),
              h("p", { className: "text-slate-400" }, "London, 1890. Defuse or detonate?")
            ),
            h("div", { className: "space-y-6" },
              h("div", null,
                h("label", { className: "block text-white mb-2 font-semibold" }, "Your Name"),
                h("input", { type: "text", value: playerName, onChange: (e) => setPlayerName(e.target.value), placeholder: "Enter your name", maxLength: 20, className: "w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" })
              ),
              error && h("div", { className: "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm" }, error),
              h("button", { onClick: createRoom, disabled: loading, className: "w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-blue-600 transition-all shadow-lg disabled:opacity-50" }, loading ? "Creating..." : "Create Room"),
              h("div", { className: "relative" },
                h("div", { className: "absolute inset-0 flex items-center" }, h("div", { className: "w-full border-t border-slate-600" })),
                h("div", { className: "relative flex justify-center text-sm" }, h("span", { className: "px-2 bg-slate-800 text-slate-400" }, "OR"))
              ),
              h("div", null,
                h("label", { className: "block text-white mb-2 font-semibold" }, "Room Code"),
                h("input", { type: "text", value: inputCode, onChange: (e) => setInputCode(e.target.value.toUpperCase()), placeholder: "Enter 5-character code", maxLength: 5, className: "w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none uppercase" })
              ),
              h("button", { onClick: joinRoom, disabled: loading, className: "w-full bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-lg font-bold text-lg transition-all disabled:opacity-50" }, loading ? "Joining..." : "Join Room")
            )
          )
        );
      }

      function LobbyScreen({ roomCode, playerId, gameState, copied, error, copyRoomCode, updatePlayerCount, toggleReady, startGame, leaveRoom }) {
        const [isLoading, setIsLoading] = useState(false);
        const isHost = playerId === gameState.hostId;
        const allReady = gameState.players.every((p) => p.ready) && gameState.players.length === gameState.playerCount;

        return h("div", { className: "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4" },
          h("div", { className: "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full border border-slate-700" },
            h("div", { className: "text-center mb-6" },
              h("h2", { className: "text-3xl font-bold text-white mb-4" }, "Game Lobby"),
              h("div", { className: "bg-slate-900 rounded-lg p-4 mb-4" },
                h("div", { className: "text-slate-400 text-sm mb-1" }, "Room Code"),
                h("div", { className: "flex items-center justify-center gap-2" },
                  h("div", { className: "text-4xl font-bold text-white tracking-wider" }, roomCode),
                  h("button", { onClick: copyRoomCode, className: "p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-all" }, copied ? "âœ“" : "ðŸ“‹")
                )
              )
            ),
            isHost && h("div", { className: "mb-6" },
              h("label", { className: "block text-white mb-3 font-semibold" }, h(IconUsers, { className: "inline w-5 h-5 mr-2" }), "Number of Players"),
              h("div", { className: "grid grid-cols-5 gap-2" }, [4, 5, 6, 7, 8].map((num) =>
                  h("button", { key: num, onClick: () => updatePlayerCount(num), className: `py-3 rounded-lg font-bold transition-all ${gameState.playerCount === num ? "bg-blue-500 text-white shadow-lg" : "bg-slate-700 text-slate-300 hover:bg-slate-600"}` }, num)
              ))
            ),
            h("div", { className: "mb-6" },
              h("div", { className: "space-y-2" }, gameState.players.map((player) =>
                  h("div", { key: player.id, className: "bg-slate-700 rounded-lg p-3 flex justify-between items-center" },
                    h("div", { className: "flex items-center gap-2" },
                      h("div", { className: `w-3 h-3 rounded-full ${player.ready ? "bg-green-400" : "bg-slate-500"}` }),
                      h("span", { className: "text-white font-medium" }, player.name),
                      player.id === gameState.hostId && h("span", { className: "text-xs bg-yellow-500 text-slate-900 px-2 py-1 rounded font-bold" }, "HOST")
                    ),
                    h("div", { className: "text-sm text-slate-400" }, player.ready ? "âœ“ Ready" : "Not ready")
                  )
              ))
            ),
            h("div", { className: "flex gap-3" },
                h("button", { onClick: toggleReady, className: `flex-1 py-3 rounded-lg font-bold transition-all ${gameState.players.find((p) => p.id === playerId)?.ready ? "bg-slate-600 text-white" : "bg-green-600 hover:bg-green-500 text-white"}` }, gameState.players.find((p) => p.id === playerId)?.ready ? "âœ“ Ready" : "Ready Up"),
                isHost && h("button", { onClick: async () => { setIsLoading(true); await startGame(); setIsLoading(false); }, disabled: !allReady || isLoading, className: "flex-1 bg-gradient-to-r from-blue-600 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-blue-700 disabled:opacity-50" }, isLoading ? "Starting..." : "Start Game")
            )
          )
        );
      }

      function EndScreen({ gameState, myRole, playerId, playAgain, leaveRoom, roomCode }) {
        const isWinner = (gameState.winner === "sherlock" && myRole === "sherlock") || (gameState.winner === "moriarty" && myRole === "moriarty");
        return h("div", { className: "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4" },
          h("div", { className: "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-slate-700 text-center" },
            h("h2", { className: "text-3xl font-bold text-white mb-4" }, gameState.winner === "sherlock" ? "Bomb Defused!" : "Big Ben Destroyed!"),
            h("p", { className: `text-xl mb-6 font-bold ${gameState.winner === "sherlock" ? "text-blue-400" : "text-red-400"}` }, gameState.winner === "sherlock" ? "Sherlock's Team Wins!" : "Moriarty's Team Wins!"),
            h("div", { className: "bg-slate-900 rounded-lg p-4 mb-6" },
              h("p", { className: `text-lg font-bold ${isWinner ? "text-green-400" : "text-orange-400"}` }, isWinner ? "ðŸŽ‰ You Won!" : "ðŸ˜” You Lost"),
              h("p", { className: "text-slate-400 mt-2" }, `You were ${myRole === "sherlock" ? "Sherlock" : "Moriarty"}`)
            ),
            h("div", { className: "flex gap-2" },
              playerId === gameState.hostId && h("button", { onClick: playAgain, className: "flex-1 bg-green-600 text-white py-4 rounded-lg font-bold" }, "Play Again"),
              h("button", { onClick: leaveRoom, className: "flex-1 bg-slate-600 text-white py-4 rounded-lg font-bold" }, "Leave")
            )
          )
        );
      }

      // ==========================================
      // NEW GAME SCREEN COMPONENTS (VISUAL OVERHAUL)
      // ==========================================

      // --- 1. Passport (Role Identity) ---
      function RolePassport({ role, teamConfig }) {
        const [isOpen, setIsOpen] = useState(false);
        const isSherlock = role === 'sherlock';

        return h("div", { className: `fixed bottom-4 left-4 z-50 transition-all duration-300 ${isOpen ? 'translate-y-0' : 'translate-y-[calc(100%-60px)]'}` },
          h("div", {
            className: `w-72 shadow-2xl rounded-t-lg overflow-hidden border-2 cursor-pointer ${isSherlock ? 'bg-slate-800 border-yellow-600' : 'bg-neutral-900 border-red-800'}`,
            onClick: () => setIsOpen(!isOpen)
          },
            h("div", { className: `p-3 flex items-center justify-between ${isSherlock ? 'bg-blue-900/50' : 'bg-red-900/50'}` },
              h("div", { className: "flex items-center gap-2" },
                h("div", { className: "w-8 h-8 rounded-full border border-white/20 flex items-center justify-center font-serif font-bold text-white" }, "?"),
                h("span", { className: "font-serif font-bold text-sm tracking-wider text-white" }, "SECRET IDENTITY")
              ),
              h("span", { className: "text-xs opacity-70 text-white" }, isOpen ? "â–¼" : "â–²")
            ),
            h("div", { className: "p-5" },
              h("div", { className: "text-center mb-4" },
                isSherlock 
                  ? h(IconShield, { className: "w-16 h-16 mx-auto text-blue-400 mb-2" })
                  : h(IconBomb, { className: "w-16 h-16 mx-auto text-red-500 mb-2" }),
                h("h3", { className: `text-xl font-bold font-serif ${isSherlock ? 'text-blue-300' : 'text-red-400'}` }, isSherlock ? "TEAM SHERLOCK" : "TEAM MORIARTY")
              ),
              h("div", { className: "text-xs space-y-3 font-mono text-slate-300" },
                h("p", null, h("strong", null, "OBJECTIVE: "), isSherlock ? "Find all defusing wires." : "Detonate the bomb OR run out of rounds."),
                h("div", { className: "mt-4 pt-3 border-t border-white/10" },
                  h("div", { className: "flex justify-between" }, "Sherlock Agents:", h("span", { className: "text-white" }, teamConfig.sherlock)),
                  h("div", { className: "flex justify-between" }, "Moriarty Agents:", h("span", { className: "text-white" }, teamConfig.moriarty))
                )
              )
            )
          )
        );
      }

      // --- 2. Action Banner ---
      function ActionBanner({ isMyTurn, currentPlayerName, status }) {
        if (status !== 'playing') return null;
        return h("div", { className: "fixed top-24 left-1/2 -translate-x-1/2 w-full max-w-xl px-4 z-40 pointer-events-none" },
          h("div", {
            className: `rounded-xl p-4 shadow-2xl backdrop-blur-md border transition-all duration-500 transform text-center ${isMyTurn ? 'bg-yellow-900/90 border-yellow-400 scale-105 animate-pulse' : 'bg-slate-900/80 border-slate-700 scale-100'}`
          },
            h("div", { className: "flex items-center justify-center gap-4" },
              isMyTurn ? h(IconScissors, { className: "w-8 h-8 text-yellow-400" }) : h(IconEye, { className: "w-6 h-6 text-slate-400" }),
              h("div", null,
                h("div", { className: `font-bold text-lg ${isMyTurn ? 'text-yellow-100' : 'text-slate-200'}` }, isMyTurn ? "YOUR TURN" : `${currentPlayerName}'s Turn`),
                h("div", { className: `text-xs uppercase tracking-widest ${isMyTurn ? 'text-yellow-300' : 'text-slate-400'}` }, isMyTurn ? "HOLD WIRE TO CUT" : "WAITING FOR ACTION...")
              )
            )
          )
        );
      }

      // --- 3. Wire Component (New Hold-to-Cut Logic) ---
      function Wire({ id, type, revealed, disabled, onCut, canCut }) {
        const [holding, setHolding] = useState(false);
        const [progress, setProgress] = useState(0);
        const requestRef = useRef();
        const startTimeRef = useRef();

        const animate = (time) => {
          if (!startTimeRef.current) startTimeRef.current = time;
          const deltaTime = time - startTimeRef.current;
          const newProgress = Math.min((deltaTime / 1000) * 100, 100); // 1 second to cut
          setProgress(newProgress);
          if (newProgress < 100) {
            requestRef.current = requestAnimationFrame(animate);
          } else {
            onCut();
            setHolding(false);
            setProgress(0);
          }
        };

        const startHold = (e) => {
          if (disabled || !canCut || revealed) return;
          e.preventDefault(); 
          setHolding(true);
          startTimeRef.current = null;
          requestRef.current = requestAnimationFrame(animate);
        };

        const resetHold = () => {
          setHolding(false);
          setProgress(0);
          if (requestRef.current) cancelAnimationFrame(requestRef.current);
        };

        let wireColor = "bg-slate-600";
        let icon = null;
        let glow = "";

        if (revealed) {
          if (type === 'bomb') { wireColor = "bg-red-600"; icon = "ðŸ’£"; glow="shadow-[0_0_15px_rgba(220,38,38,0.8)]"; }
          else if (type === 'defusing') { wireColor = "bg-blue-500"; icon = "âœ‚ï¸"; glow="shadow-[0_0_15px_rgba(59,130,246,0.8)]"; }
          else { wireColor = "bg-transparent border-2 border-slate-700 opacity-30"; } 
        }

        return h("div", {
          className: "relative flex flex-col items-center group",
          onMouseDown: startHold, onMouseUp: resetHold, onMouseLeave: resetHold,
          onTouchStart: startHold, onTouchEnd: resetHold
        },
          h("div", { className: "w-3 h-3 rounded-full bg-slate-400 mb-[-2px] z-10" }),
          h("div", {
            className: `w-2 h-24 transition-all duration-100 relative overflow-hidden ${!revealed ? 'bg-gradient-to-b from-amber-700 via-amber-600 to-amber-800 cursor-pointer' : wireColor} ${holding ? 'scale-x-125 wire-tension' : ''} ${glow}`
          },
            !revealed && holding && h("div", { className: "absolute top-0 left-0 w-full bg-white mix-blend-overlay", style: { height: `${progress}%` } }),
            revealed && icon && h("div", { className: "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl" }, icon)
          ),
          h("div", { className: "w-3 h-3 rounded-full bg-slate-400 mt-[-2px] z-10" }),
          canCut && !revealed && h("div", { className: "absolute -bottom-8 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] bg-black px-2 py-1 rounded text-white whitespace-nowrap z-20 pointer-events-none" }, "Hold to Cut")
        );
      }

      // --- 4. Player Dossier (Visual Card) ---
      function PlayerDossier({ player, isCurrentPlayer, isMe, onCutWire, canICut, announcement }) {
        return h("div", {
          className: `relative bg-slate-800 rounded-lg p-4 border-t-4 transition-all duration-300 ${isCurrentPlayer ? 'border-yellow-500 shadow-[0_0_30px_rgba(234,179,8,0.15)] -translate-y-2' : 'border-slate-600 opacity-90'} ${isMe ? 'ring-2 ring-blue-500/50' : ''}`
        },
          h("div", { className: "flex justify-between items-start mb-4" },
            h("div", null,
              h("h3", { className: "font-serif font-bold text-white text-lg leading-none" }, player.name, isMe && " (YOU)"),
              isCurrentPlayer && h("span", { className: "text-[10px] text-yellow-500 font-bold uppercase tracking-widest" }, "ACTING NOW")
            ),
            h("div", { className: `w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-xl border ${isCurrentPlayer ? 'border-yellow-500' : 'border-slate-600'}` }, isCurrentPlayer ? "âœ‚ï¸" : "ðŸ‘¤")
          ),
          h("div", { className: "flex justify-center gap-3 bg-slate-900/50 rounded-lg p-3 min-h-[120px]" },
             player.wires.map(wire => h(Wire, { key: wire.id, ...wire, canCut: canICut && !isMe, onCut: () => onCutWire(player.id, wire.id) }))
          ),
          announcement && announcement.locked && h("div", { 
            className: "absolute -right-2 -top-2 rotate-12 bg-white text-slate-900 px-2 py-1 shadow-lg text-xs font-bold border border-slate-400 font-serif transform"
          }, 
            h("span", { className: "text-blue-700 block leading-tight" }, `Def: ${announcement.defusing}`),
            h("span", { className: "text-red-700 block leading-tight" }, `Bomb: ${announcement.bomb}`)
          )
        );
      }

      // --- 5. The Redesigned Game Screen ---
      function GameScreen({ gameState, playerId, myRole, cutWire }) {
        // --- ANNOUNCEMENT LOGIC INTEGRATED HERE ---
        const [showAnnouncementPopup, setShowAnnouncementPopup] = useState(false);
        const [myAnnouncement, setMyAnnouncement] = useState({ defusing: 0, bomb: 0 });
        
        const currentPlayer = gameState.players[gameState.currentPlayer];
        const isMyTurn = currentPlayer.id === playerId;
        const myPlayer = gameState.players.find(p => p.id === playerId);
        const round = gameState.round;
        const totalDefusing = gameState.config.defusing;
        const foundDefusing = gameState.defusingFound || 0;
        
        // Announcements check
        const currentRoundAnnouncements = gameState.announcements || {};
        const myLockedAnnouncement = currentRoundAnnouncements[playerId] && currentRoundAnnouncements[playerId].round === round && currentRoundAnnouncements[playerId].locked;
        const allAnnounced = gameState.players.every(p => {
            const ann = currentRoundAnnouncements[p.id];
            return ann && ann.round === round && ann.locked;
        });

        // Trigger popup if new round and I haven't announced
        useEffect(() => {
            if (!myLockedAnnouncement) setShowAnnouncementPopup(true);
        }, [round, myLockedAnnouncement]);

        const submitAnnouncement = async () => {
            await database.ref(`rooms/${gameState.code}/announcements/${playerId}`).set({
                name: myPlayer.name, defusing: myAnnouncement.defusing, bomb: myAnnouncement.bomb, round: gameState.round, locked: true
            });
            setShowAnnouncementPopup(false);
        };

        const themeClass = myRole === 'moriarty' ? 'vignette-moriarty' : 'vignette-sherlock';

        return h("div", { className: `min-h-screen relative overflow-hidden bg-slate-950 ${themeClass}` },
          // --- TOP HUD ---
          h("div", { className: "bg-slate-900/90 border-b border-slate-700 p-2 md:p-4 sticky top-0 z-30 flex justify-between items-center shadow-lg" },
            h("div", { className: "flex items-center gap-3 w-1/3" },
              h("div", { className: "relative w-full max-w-[150px] h-4 bg-slate-800 rounded-full overflow-hidden border border-slate-600" },
                h("div", { className: "absolute top-0 left-0 h-full bg-blue-500 transition-all duration-1000 ease-out", style: { width: `${(foundDefusing / totalDefusing) * 100}%` } })
              ),
              h("div", { className: "text-blue-400 font-mono text-xs md:text-sm whitespace-nowrap" }, `${foundDefusing}/${totalDefusing} Defused`)
            ),
            h("div", { className: "flex flex-col items-center justify-center -mb-8 z-40" },
              h("div", { className: "w-16 h-16 bg-slate-800 rounded-full border-4 border-amber-600 flex items-center justify-center shadow-2xl relative" },
                 h("div", { className: "absolute w-1 h-6 bg-slate-400 top-2 rounded origin-bottom" }),
                 h("div", { className: "absolute w-1 h-4 bg-slate-200 top-4 rounded origin-bottom transform rotate-90" }),
                 h("span", { className: "font-serif text-2xl font-bold text-amber-500 mt-1" }, round)
              ),
              h("span", { className: "text-amber-600 text-[10px] font-bold uppercase tracking-widest mt-1 bg-slate-900 px-2 rounded" }, "ROUND")
            ),
            h("div", { className: "w-1/3 text-right" },
               h("div", { className: "text-slate-400 text-xs uppercase" }, "Cuts Left"),
               h("div", { className: "text-2xl font-mono text-red-500 font-bold" }, gameState.playerCount - (gameState.revealedInRound || 0))
            )
          ),

          // --- ACTION BANNER ---
          h(ActionBanner, { isMyTurn, currentPlayerName: currentPlayer.name, status: gameState.status }),

          // --- MAIN GRID ---
          h("div", { className: "container mx-auto px-4 pt-24 pb-32 max-w-6xl" },
            !allAnnounced && h("div", { className: "mb-8 text-center" },
                h("div", { className: "inline-block bg-amber-900/80 text-amber-200 px-4 py-2 rounded-lg border border-amber-700 animate-pulse" }, "âš ï¸ Waiting for declarations...")
            ),
            h("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
               gameState.players.map(p => 
                 h(PlayerDossier, {
                   key: p.id, player: p, isMe: p.id === playerId,
                   isCurrentPlayer: p.id === currentPlayer.id,
                   canICut: isMyTurn && allAnnounced,
                   onCutWire: cutWire,
                   announcement: currentRoundAnnouncements[p.id]
                 })
               )
            )
          ),

          // --- ROLE PASSPORT ---
          h(RolePassport, { role: myRole, teamConfig: gameState.config }),

          // --- ANNOUNCEMENT POPUP ---
          showAnnouncementPopup && h("div", { className: "announcement-backdrop", onClick: () => {} },
             h("div", { className: "announcement-popup bg-slate-800 w-full max-w-md rounded-xl p-6 border-2 border-amber-600 shadow-2xl" },
                h("h2", { className: "text-2xl font-serif text-white mb-2 text-center" }, "Interrogation Phase"),
                h("p", { className: "text-slate-400 text-center mb-6 text-sm" }, "Declare your wire counts to the room. You may lie."),
                h("div", { className: "bg-slate-900 p-3 rounded mb-6 text-center text-xs text-slate-500" },
                   "Your Actual Hand: ",
                   h("span", { className: "text-blue-400 ml-2" }, `Def: ${myPlayer.wires.filter(w=>w.type==='defusing' && !w.revealed).length}`),
                   h("span", { className: "text-red-400 ml-2" }, `Bomb: ${myPlayer.wires.filter(w=>w.type==='bomb' && !w.revealed).length}`)
                ),
                h("div", { className: "space-y-4 mb-8" },
                   h("div", { className: "flex justify-between items-center bg-slate-700/50 p-4 rounded-lg" },
                      h("span", { className: "text-blue-400 font-bold" }, "Defusing Wires"),
                      h("div", { className: "flex items-center gap-4" },
                         h("button", { className: "w-8 h-8 rounded bg-slate-600 text-white", onClick: () => setMyAnnouncement(p => ({...p, defusing: Math.max(0, p.defusing-1)})) }, "-"),
                         h("span", { className: "text-xl w-6 text-center text-white" }, myAnnouncement.defusing),
                         h("button", { className: "w-8 h-8 rounded bg-slate-600 text-white", onClick: () => setMyAnnouncement(p => ({...p, defusing: Math.min(5, p.defusing+1)})) }, "+"),
                      )
                   ),
                   h("div", { className: "flex justify-between items-center bg-slate-700/50 p-4 rounded-lg" },
                      h("span", { className: "text-red-500 font-bold" }, "Bombs"),
                      h("div", { className: "flex items-center gap-4" },
                         h("button", { className: "w-8 h-8 rounded bg-slate-600 text-white", onClick: () => setMyAnnouncement(p => ({...p, bomb: Math.max(0, p.bomb-1)})) }, "-"),
                         h("span", { className: "text-xl w-6 text-center text-white" }, myAnnouncement.bomb),
                         h("button", { className: "w-8 h-8 rounded bg-slate-600 text-white", onClick: () => setMyAnnouncement(p => ({...p, bomb: Math.min(5, p.bomb+1)})) }, "+"),
                      )
                   )
                ),
                h("button", { className: "w-full py-4 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg uppercase tracking-widest", onClick: submitAnnouncement }, "Declare Cards")
             )
          )
        );
      }

      // ==========================================
      // MAIN APP (Logic Preserved)
      // ==========================================
      function TimeBombGame() {
        const [screen, setScreen] = useState("home");
        const [roomCode, setRoomCode] = useState("");
        const [inputCode, setInputCode] = useState("");
        const [playerId, setPlayerId] = useState(null);
        const [playerName, setPlayerName] = useState("");
        const [gameState, setGameState] = useState(null);
        const [myRole, setMyRole] = useState(null);
        const [copied, setCopied] = useState(false);
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          if (!roomCode) return;
          const roomRef = database.ref(`rooms/${roomCode}`);
          const handleUpdate = (snapshot) => {
            const state = snapshot.val();
            if (state) {
              setGameState(state);
              if (state.status === "lobby" && screen !== "lobby") setScreen("lobby");
              else if (state.status === "playing" && screen !== "game") {
                setScreen("game");
                if (!myRole && playerId !== null) {
                  const player = state.players.find((p) => p.id === playerId);
                  if (player) setMyRole(player.role);
                }
              } else if (state.status === "ended" && screen !== "end") setScreen("end");
            } else {
              setScreen("home");
              setRoomCode("");
              setPlayerId(null);
              setGameState(null);
              setMyRole(null);
              setError("Room closed.");
            }
          };
          roomRef.on("value", handleUpdate);
          return () => roomRef.off("value", handleUpdate);
        }, [roomCode, playerId, myRole, screen]);

        const createRoom = async () => {
          if (!playerName.trim()) return setError("Enter name");
          setLoading(true);
          const code = generateRoomCode();
          const newPlayerId = 0;
          const initialState = { code, status: "lobby", hostId: newPlayerId, playerCount: 5, players: [{ id: newPlayerId, name: playerName.trim(), ready: false }], createdAt: Date.now() };
          await database.ref(`rooms/${code}`).set(initialState);
          setRoomCode(code);
          setPlayerId(newPlayerId);
          setGameState(initialState);
          setScreen("lobby");
          setLoading(false);
        };

        const joinRoom = async () => {
          if (!playerName.trim() || !inputCode.trim()) return setError("Check inputs");
          setLoading(true);
          const code = inputCode.trim().toUpperCase();
          const snapshot = await database.ref(`rooms/${code}`).once("value");
          if (!snapshot.exists()) { setLoading(false); return setError("Room not found"); }
          const state = snapshot.val();
          if (state.status !== "lobby") { setLoading(false); return setError("Game started"); }
          const newPlayerId = Math.max(...state.players.map((p) => p.id)) + 1;
          state.players.push({ id: newPlayerId, name: playerName.trim(), ready: false });
          await database.ref(`rooms/${code}`).set(state);
          setRoomCode(code);
          setPlayerId(newPlayerId);
          setGameState(state);
          setScreen("lobby");
          setLoading(false);
        };

        const startGame = async () => {
            if (playerId !== gameState.hostId) return;
            const config = GAME_CONFIG[gameState.playerCount];
            if (!config) return;
            const roles = [...Array(config.sherlock).fill("sherlock"), ...Array(config.moriarty).fill("moriarty")].sort(() => Math.random() - 0.5);
            const wireDeck = [...Array(config.defusing).fill("defusing"), ...Array(config.bomb).fill("bomb"), ...Array(config.wires).fill("safe")].sort(() => Math.random() - 0.5);
            const playersWithRoles = gameState.players.map((player, idx) => ({
                ...player, role: roles[idx],
                wires: wireDeck.slice(idx * 5, (idx + 1) * 5).map((type, wireIdx) => ({ id: `${player.id}-0-${wireIdx}`, type, revealed: false }))
            }));
            await database.ref(`rooms/${roomCode}`).set({
                ...gameState, status: "playing", players: playersWithRoles, currentPlayer: Math.floor(Math.random() * gameState.players.length), round: 1, revealedInRound: 0, defusingFound: 0, config
            });
        };

        const cutWire = async (targetPlayerId, wireId) => {
            // Note: In the new UI, this is called directly by the Wire component
            if (gameState.players[gameState.currentPlayer].id !== playerId) return;
            const newState = JSON.parse(JSON.stringify(gameState));
            const targetPlayer = newState.players.find(p => p.id === targetPlayerId);
            const wire = targetPlayer.wires.find(w => w.id === wireId);
            if (wire.revealed) return;
            wire.revealed = true;
            
            if (wire.type === "bomb") {
                newState.status = "ended"; newState.winner = "moriarty";
            } else if (wire.type === "defusing") {
                newState.defusingFound += 1;
                if (newState.defusingFound === newState.config.defusing) { newState.status = "ended"; newState.winner = "sherlock"; }
            }
            
            if (newState.status !== "ended") {
                newState.revealedInRound += 1;
                if (newState.revealedInRound === newState.playerCount) {
                    if (newState.round === 4) {
                        newState.status = "ended"; newState.winner = "moriarty";
                    } else {
                        // Redistribution Logic (Simplified shuffling of unrevealed wires)
                        const unrevealed = newState.players.flatMap(p => p.wires.filter(w => !w.revealed).map(w => w.type)).sort(() => Math.random() - 0.5);
                        const wiresPerPlayer = Math.floor(unrevealed.length / newState.playerCount);
                        newState.players = newState.players.map((p, i) => ({
                            ...p, wires: unrevealed.slice(i * wiresPerPlayer, (i + 1) * wiresPerPlayer).map((t, wi) => ({ id: `${p.id}-${newState.round}-${wi}`, type: t, revealed: false }))
                        }));
                        newState.round += 1;
                        newState.revealedInRound = 0;
                        newState.announcements = {}; // Clear announcements for new round
                    }
                } else {
                    newState.currentPlayer = newState.players.findIndex(p => p.id === targetPlayerId);
                }
            }
            await database.ref(`rooms/${roomCode}`).set(newState);
        };

        if (screen === "home") return h(HomeScreen, { playerName, setPlayerName, inputCode, setInputCode, error, loading, createRoom, joinRoom });
        if (screen === "lobby") return h(LobbyScreen, { roomCode, playerId, gameState, copied, error, copyRoomCode: () => { navigator.clipboard.writeText(roomCode); setCopied(true); setTimeout(() => setCopied(false), 2000); }, updatePlayerCount: async (n) => await database.ref(`rooms/${roomCode}/playerCount`).set(n), toggleReady: async () => { const idx = gameState.players.findIndex(p => p.id === playerId); await database.ref(`rooms/${roomCode}/players/${idx}/ready`).set(!gameState.players[idx].ready); }, startGame, leaveRoom: async () => { setScreen("home"); setRoomCode(""); } });
        if (screen === "game") return h(GameScreen, { gameState, playerId, myRole, cutWire });
        if (screen === "end") return h(EndScreen, { gameState, myRole, playerId, playAgain: startGame, leaveRoom: async () => { setScreen("home"); setRoomCode(""); }, roomCode });
        return null;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(h(TimeBombGame));
    </script>
  </body>
</html>