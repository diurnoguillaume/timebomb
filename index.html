<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Bomb - Multiplayer Game</title>
    <meta
      name="description"
      content="Time Bomb - A thrilling online multiplayer deduction game. Create a room, share the code, and play with friends!"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
          "Helvetica Neue", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      #root {
        width: 100%;
        min-height: 100vh;
      }

      /* ==========================================
         PHASE SYSTEM - Visual distinction for game phases
         ========================================== */

      /* Phase Indicator Bar */
      .phase-bar {
        position: relative;
        overflow: hidden;
      }
      .phase-bar::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--phase-color, #3b82f6) 0%,
          transparent 100%
        );
        animation: phaseProgress 2s ease-in-out infinite;
      }
      @keyframes phaseProgress {
        0%,
        100% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(100%);
        }
      }

      /* Announcement Phase */
      .phase-announcement {
        --phase-color: #f59e0b;
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.1) 0%,
          transparent 50%
        );
      }
      .phase-announcement .phase-indicator {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      /* Wire Cutting Phase */
      .phase-cutting {
        --phase-color: #ef4444;
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.1) 0%,
          transparent 50%
        );
      }
      .phase-cutting .phase-indicator {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      /* ==========================================
         TENSION SYSTEM - Escalating urgency
         ========================================== */

      /* Round-based urgency colors */
      .urgency-1 {
        --urgency-color: #22c55e;
        --urgency-bg: rgba(34, 197, 94, 0.1);
      }
      .urgency-2 {
        --urgency-color: #eab308;
        --urgency-bg: rgba(234, 179, 8, 0.1);
      }
      .urgency-3 {
        --urgency-color: #f97316;
        --urgency-bg: rgba(249, 115, 22, 0.15);
      }
      .urgency-4 {
        --urgency-color: #ef4444;
        --urgency-bg: rgba(239, 68, 68, 0.2);
      }

      /* Heartbeat effect for high tension */
      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        14% {
          transform: scale(1.05);
        }
        28% {
          transform: scale(1);
        }
        42% {
          transform: scale(1.03);
        }
        56% {
          transform: scale(1);
        }
      }
      .heartbeat-slow {
        animation: heartbeat 2s ease-in-out infinite;
      }
      .heartbeat-medium {
        animation: heartbeat 1.5s ease-in-out infinite;
      }
      .heartbeat-fast {
        animation: heartbeat 1s ease-in-out infinite;
      }
      .heartbeat-critical {
        animation: heartbeat 0.6s ease-in-out infinite;
      }

      /* Pulsing border for urgency */
      @keyframes urgentPulse {
        0%,
        100% {
          border-color: var(--urgency-color);
          box-shadow: 0 0 10px var(--urgency-bg);
        }
        50% {
          border-color: transparent;
          box-shadow: 0 0 25px var(--urgency-color);
        }
      }
      .urgent-border {
        border: 2px solid var(--urgency-color);
        animation: urgentPulse 1.5s ease-in-out infinite;
      }

      /* Countdown timer animation */
      @keyframes countdown {
        0% {
          stroke-dashoffset: 0;
        }
        100% {
          stroke-dashoffset: 283;
        }
      }
      .countdown-ring {
        stroke-dasharray: 283;
        stroke-dashoffset: 0;
        transform-origin: center;
        transform: rotate(-90deg);
      }

      /* ==========================================
         PLAYER CARD ENHANCEMENTS
         ========================================== */

      /* Active turn spotlight */
      @keyframes spotlightPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(250, 204, 21, 0.4),
            0 0 40px rgba(250, 204, 21, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        50% {
          box-shadow: 0 0 30px rgba(250, 204, 21, 0.6),
            0 0 60px rgba(250, 204, 21, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
      }
      .player-spotlight {
        animation: spotlightPulse 2s ease-in-out infinite;
        border-color: #facc15 !important;
        position: relative;
      }
      .player-spotlight::before {
        content: "âœ‚ï¸ CUTTING";
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #facc15, #f59e0b);
        color: #1e293b;
        font-size: 0.65rem;
        font-weight: 800;
        padding: 2px 10px;
        border-radius: 10px;
        letter-spacing: 0.5px;
        white-space: nowrap;
        z-index: 10;
      }

      /* Suspicion indicator */
      .suspicion-meter {
        height: 3px;
        background: #334155;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }
      .suspicion-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease-out, background-color 0.3s ease;
      }
      .suspicion-low {
        background: linear-gradient(90deg, #22c55e, #4ade80);
      }
      .suspicion-medium {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }
      .suspicion-high {
        background: linear-gradient(90deg, #ef4444, #f87171);
      }

      /* Player activity ring */
      .activity-ring {
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid;
      }
      .activity-recent {
        border-color: #22c55e;
        background: #22c55e;
      }
      .activity-waiting {
        border-color: #f59e0b;
        animation: blink 1.5s infinite;
      }
      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      /* ==========================================
         ANNOUNCEMENT SYSTEM ENHANCEMENTS
         ========================================== */

      /* Announcement history card */
      .announcement-history {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.9),
          rgba(15, 23, 42, 0.95)
        );
        border: 1px solid #334155;
        backdrop-filter: blur(8px);
      }
      .announcement-history-item {
        position: relative;
        padding-left: 1rem;
        border-left: 2px solid #475569;
      }
      .announcement-history-item::before {
        content: "";
        position: absolute;
        left: -5px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #64748b;
      }
      .announcement-history-item.current::before {
        background: #f59e0b;
        box-shadow: 0 0 8px #f59e0b;
      }

      /* Bluff indicator (visual cue when claims don't match revealed cards) */
      @keyframes suspiciousGlow {
        0%,
        100% {
          box-shadow: 0 0 0 rgba(239, 68, 68, 0);
        }
        50% {
          box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
        }
      }
      .suspicious-claim {
        animation: suspiciousGlow 2s ease-in-out infinite;
        border-color: #ef4444 !important;
      }

      /* ==========================================
         ROUND TRANSITION & GAME OVER EFFECTS
         ========================================== */

      @keyframes fadeInScale {
        0% {
          opacity: 0;
          transform: scale(0.8);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes slideUp {
        0% {
          transform: translateY(20px);
          opacity: 0;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes slideIn {
        0% {
          transform: translateX(-20px);
          opacity: 0;
        }
        100% {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .round-transition-enter {
        animation: fadeInScale 0.4s ease-out forwards;
      }
      .round-transition-exit {
        animation: fadeOut 0.3s ease-out forwards;
      }
      .round-number-animate {
        animation: slideUp 0.5s ease-out 0.2s forwards;
        opacity: 0;
      }
      .slide-in {
        animation: slideIn 0.3s ease-out forwards;
      }

      /* Game Over Effects */
      @keyframes explosionPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      @keyframes screenShake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }
      @keyframes explosionFlash {
        0% {
          background-color: rgba(239, 68, 68, 0);
        }
        20% {
          background-color: rgba(239, 68, 68, 0.5);
        }
        40% {
          background-color: rgba(251, 146, 60, 0.4);
        }
        60% {
          background-color: rgba(239, 68, 68, 0.3);
        }
        100% {
          background-color: rgba(0, 0, 0, 0.8);
        }
      }
      @keyframes victoryGlow {
        0% {
          background-color: rgba(59, 130, 246, 0);
        }
        50% {
          background-color: rgba(59, 130, 246, 0.3);
        }
        100% {
          background-color: rgba(0, 0, 0, 0.8);
        }
      }
      @keyframes bombEmoji {
        0% {
          transform: scale(1) rotate(0deg);
        }
        25% {
          transform: scale(1.5) rotate(-10deg);
        }
        50% {
          transform: scale(2) rotate(10deg);
        }
        75% {
          transform: scale(2.5) rotate(-5deg);
        }
        100% {
          transform: scale(3) rotate(0deg);
          opacity: 0;
        }
      }
      @keyframes defuseSuccess {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
      .screen-shake {
        animation: screenShake 0.5s ease-in-out;
      }
      .explosion-overlay {
        animation: explosionFlash 1.5s ease-out forwards;
      }
      .victory-overlay {
        animation: victoryGlow 1.5s ease-out forwards;
      }
      .bomb-explode {
        animation: bombEmoji 1s ease-out forwards;
      }
      .defuse-success {
        animation: defuseSuccess 0.5s ease-out;
      }

      /* ==========================================
         ANNOUNCEMENT POPUP
         ========================================== */

      @keyframes popupSlideIn {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      @keyframes popupSlideOut {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
      }
      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(234, 179, 8, 0.6);
        }
      }
      .announcement-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: popupSlideIn 0.3s ease-out forwards;
        z-index: 60;
      }
      .announcement-popup-exit {
        animation: popupSlideOut 0.2s ease-out forwards;
      }
      .announcement-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 55;
        animation: fadeInScale 0.2s ease-out;
        backdrop-filter: blur(4px);
      }
      .pulse-attention {
        animation: pulse-glow 2s infinite;
      }
      .announcement-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 6px;
        white-space: nowrap;
        font-weight: 600;
      }

      /* ==========================================
         WIRE CUTTING ENHANCEMENTS
         ========================================== */

      @keyframes wireHover {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        }
      }
      .wire-selectable:hover {
        animation: wireHover 0.4s ease-in-out;
      }
      .wire-selected {
        animation: spotlightPulse 1s ease-in-out infinite;
        transform: scale(1.1);
      }

      /* Cut confirmation button */
      @keyframes confirmPulse {
        0%,
        100% {
          transform: translateX(-50%) scale(1);
        }
        50% {
          transform: translateX(-50%) scale(1.05);
        }
      }
      .cut-confirm-btn {
        animation: confirmPulse 1.5s ease-in-out infinite;
      }

      /* ==========================================
         TOOLTIP SYSTEM
         ========================================== */

      .tooltip-container {
        position: relative;
      }
      .tooltip {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #e2e8f0;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid #334155;
      }
      .tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1e293b;
      }
      .tooltip-container:hover .tooltip {
        opacity: 1;
        visibility: visible;
      }

      /* ==========================================
         ROLE-SPECIFIC THEMING
         ========================================== */

      .role-sherlock {
        --role-primary: #3b82f6;
        --role-secondary: #60a5fa;
        --role-bg: rgba(59, 130, 246, 0.1);
        --role-border: rgba(59, 130, 246, 0.3);
      }
      .role-moriarty {
        --role-primary: #ef4444;
        --role-secondary: #f87171;
        --role-bg: rgba(239, 68, 68, 0.1);
        --role-border: rgba(239, 68, 68, 0.3);
      }
      .role-card {
        background: var(--role-bg);
        border: 1px solid var(--role-border);
        position: relative;
        overflow: hidden;
      }
      .role-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--role-primary),
          var(--role-secondary)
        );
      }

      /* ==========================================
         PROGRESS INDICATORS
         ========================================== */

      .progress-track {
        height: 8px;
        background: #1e293b;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-out;
        position: relative;
      }
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        animation: shimmer 2s infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      /* Mobile responsiveness */
      @media (max-width: 640px) {
        .announcement-popup {
          width: 95% !important;
          max-width: none !important;
        }
        .player-spotlight::before {
          font-size: 0.55rem;
          padding: 1px 6px;
        }

        /* Mobile-first game layout */
        .mobile-header {
          padding: 0.75rem !important;
        }
        .mobile-header .phase-indicator {
          padding: 0.5rem 0.75rem !important;
          font-size: 0.7rem !important;
        }
        .mobile-stats {
          gap: 0.5rem !important;
        }
        .mobile-stats > div {
          padding: 0.5rem !important;
          min-width: 60px;
        }
        .mobile-stats .text-xs {
          font-size: 0.6rem !important;
        }
        .mobile-stats .text-xl {
          font-size: 1rem !important;
        }
        .mobile-role-badge {
          padding: 0.375rem 0.625rem !important;
          font-size: 0.75rem !important;
        }
        .mobile-role-badge svg {
          width: 14px !important;
          height: 14px !important;
        }

        /* Compact player cards for mobile */
        .mobile-player-grid {
          gap: 0.5rem !important;
        }
        .mobile-player-card {
          padding: 0.625rem !important;
        }
        .mobile-player-card .player-name {
          font-size: 0.8rem !important;
        }
        .mobile-player-card .wire-count {
          font-size: 0.65rem !important;
        }
        .mobile-wire {
          width: 2rem !important;
          height: 2rem !important;
          font-size: 0.85rem !important;
        }

        /* Compact announcement form */
        .mobile-announcement {
          padding: 0.75rem !important;
        }
        .mobile-announcement .claim-btn {
          width: 1.75rem !important;
          height: 1.75rem !important;
          font-size: 0.9rem !important;
        }
        .mobile-announcement .claim-value {
          font-size: 1.25rem !important;
          width: 1.5rem !important;
        }
        .mobile-cards-display {
          gap: 1rem !important;
        }
        .mobile-cards-display .card-icon {
          font-size: 1.25rem !important;
        }
        .mobile-cards-display .card-count {
          font-size: 1rem !important;
        }

        /* Urgency badge compact */
        .mobile-urgency {
          padding: 0.25rem 0.5rem !important;
          font-size: 0.65rem !important;
        }
        .mobile-urgency svg {
          width: 12px !important;
          height: 12px !important;
        }

        /* Wire legend compact */
        .mobile-legend {
          padding: 0.5rem !important;
          margin-top: 0.5rem !important;
        }
        .mobile-legend .legend-title {
          font-size: 0.7rem !important;
        }
        .mobile-legend .legend-items {
          gap: 0.375rem !important;
        }
        .mobile-legend .legend-item {
          padding: 0.25rem 0.5rem !important;
          font-size: 0.65rem !important;
        }

        /* Cut confirmation button */
        .mobile-cut-btn {
          bottom: 0.5rem !important;
          padding: 0.625rem 1.25rem !important;
          font-size: 0.85rem !important;
        }

        /* Phase content compact */
        .mobile-phase-content {
          padding: 0.75rem !important;
          margin-top: 0.5rem !important;
        }
        .mobile-phase-content p {
          font-size: 0.75rem !important;
        }

        /* Announcement status grid compact */
        .mobile-ann-grid {
          gap: 0.375rem !important;
        }
        .mobile-ann-item {
          padding: 0.375rem !important;
        }
        .mobile-ann-item .name {
          font-size: 0.7rem !important;
        }
        .mobile-ann-item .claims {
          font-size: 0.6rem !important;
          gap: 0.25rem !important;
        }
      }

      /* Extra small devices */
      @media (max-width: 380px) {
        .mobile-wire {
          width: 1.75rem !important;
          height: 1.75rem !important;
          font-size: 0.75rem !important;
        }
        .mobile-player-card {
          padding: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      // ==========================================
      // FIREBASE CONFIGURATION
      // ==========================================

      const firebaseConfig = {
        apiKey: "AIzaSyDAI46UYQMVMCnNqQD9MqR3yhiHUzghYuA",
        authDomain: "timebomb-game.firebaseapp.com",
        databaseURL:
          "https://timebomb-game-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "timebomb-game",
        storageBucket: "timebomb-game.firebasestorage.app",
        messagingSenderId: "752842528482",
        appId: "1:752842528482:web:f97dd6bead7bb6bca4f0bb",
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // ==========================================
      // GAME CONFIGURATION
      // ==========================================
      const GAME_CONFIG = {
        4: { sherlock: 3, moriarty: 2, wires: 15, defusing: 4, bomb: 1 },
        5: { sherlock: 3, moriarty: 2, wires: 19, defusing: 5, bomb: 1 },
        6: { sherlock: 4, moriarty: 2, wires: 23, defusing: 6, bomb: 1 },
        7: { sherlock: 5, moriarty: 3, wires: 27, defusing: 7, bomb: 1 },
        8: { sherlock: 5, moriarty: 3, wires: 31, defusing: 8, bomb: 1 },
      };

      const generateRoomCode = () => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let code = "";
        for (let i = 0; i < 5; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      };

      // ==========================================
      // COMPONENTS
      // ==========================================
      const { useState, useEffect, createElement: h } = React;

      // ==========================================
      // SVG ICON COMPONENTS
      // ==========================================

      // Timer/Clock icon
      const Timer = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("line", { x1: "12", x2: "12", y1: "2", y2: "6" }),
          h("line", { x1: "12", x2: "12", y1: "18", y2: "22" }),
          h("line", { x1: "4.93", x2: "7.76", y1: "4.93", y2: "7.76" }),
          h("line", { x1: "16.24", x2: "19.07", y1: "16.24", y2: "19.07" }),
          h("line", { x1: "2", x2: "6", y1: "12", y2: "12" }),
          h("line", { x1: "18", x2: "22", y1: "12", y2: "12" }),
          h("line", { x1: "4.93", x2: "7.76", y1: "19.07", y2: "16.24" }),
          h("line", { x1: "16.24", x2: "19.07", y1: "7.76", y2: "4.93" })
        );

      // Shield icon (Sherlock team)
      const Shield = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", {
            d: "M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",
          })
        );

      // Zap/Lightning icon (Moriarty team)
      const Zap = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", {
            d: "M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",
          })
        );

      // Users icon
      const Users = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }),
          h("circle", { cx: "9", cy: "7", r: "4" }),
          h("path", { d: "M22 21v-2a4 4 0 0 0-3-3.87" }),
          h("path", { d: "M16 3.13a4 4 0 0 1 0 7.75" })
        );

      // Copy icon
      const Copy = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("rect", {
            width: "14",
            height: "14",
            x: "8",
            y: "8",
            rx: "2",
            ry: "2",
          }),
          h("path", {
            d: "M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",
          })
        );

      // Check icon
      const Check = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "M20 6 9 17l-5-5" })
        );

      // Scissors icon
      const Scissors = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("circle", { cx: "6", cy: "6", r: "3" }),
          h("path", { d: "M8.12 8.12 12 12" }),
          h("path", { d: "M20 4 8.12 15.88" }),
          h("circle", { cx: "6", cy: "18", r: "3" }),
          h("path", { d: "M14.8 14.8 20 20" })
        );

      // Alert Circle icon
      const AlertCircle = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("circle", { cx: "12", cy: "12", r: "10" }),
          h("line", { x1: "12", x2: "12", y1: "8", y2: "12" }),
          h("line", { x1: "12", x2: "12.01", y1: "16", y2: "16" })
        );

      // Megaphone icon (for announcements)
      const Megaphone = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "m3 11 18-5v12L3 13v-2z" }),
          h("path", { d: "M11.6 16.8a3 3 0 1 1-5.8-1.6" })
        );

      // Eye icon (for watching/suspicion)
      const Eye = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" }),
          h("circle", { cx: "12", cy: "12", r: "3" })
        );

      // Clock icon (for urgency)
      const Clock = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("circle", { cx: "12", cy: "12", r: "10" }),
          h("polyline", { points: "12 6 12 12 16 14" })
        );

      // Target icon (for current player)
      const Target = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("circle", { cx: "12", cy: "12", r: "10" }),
          h("circle", { cx: "12", cy: "12", r: "6" }),
          h("circle", { cx: "12", cy: "12", r: "2" })
        );

      // Info icon (for tooltips)
      const Info = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("circle", { cx: "12", cy: "12", r: "10" }),
          h("path", { d: "M12 16v-4" }),
          h("path", { d: "M12 8h.01" })
        );

      // History icon (for announcement history)
      const History = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" }),
          h("path", { d: "M3 3v5h5" }),
          h("path", { d: "M12 7v5l4 2" })
        );

      // Brain icon (for deduction hints)
      const Brain = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", {
            d: "M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z",
          }),
          h("path", {
            d: "M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z",
          }),
          h("path", { d: "M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4" }),
          h("path", { d: "M17.599 6.5a3 3 0 0 0 .399-1.375" }),
          h("path", { d: "M6.003 5.125A3 3 0 0 0 6.401 6.5" }),
          h("path", { d: "M3.477 10.896a4 4 0 0 1 .585-.396" }),
          h("path", { d: "M19.938 10.5a4 4 0 0 1 .585.396" }),
          h("path", { d: "M6 18a4 4 0 0 1-1.967-.516" }),
          h("path", { d: "M19.967 17.484A4 4 0 0 1 18 18" })
        );

      // Siren/Alert icon (for bomb warning)
      const Siren = (props) =>
        h(
          "svg",
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            ...props,
          },
          h("path", { d: "M7 18v-6a5 5 0 1 1 10 0v6" }),
          h("path", {
            d: "M5 21a1 1 0 0 1-1-1v-1a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v1a1 1 0 0 1-1 1Z",
          }),
          h("path", { d: "M21 12h1" }),
          h("path", { d: "M18.5 4.5 18 5" }),
          h("path", { d: "M2 12h1" }),
          h("path", { d: "M12 2v1" }),
          h("path", { d: "m4.929 4.929.707.707" }),
          h("path", { d: "M12 12v6" })
        );

      // ==========================================
      // HELPER COMPONENTS
      // ==========================================

      // Tooltip Component
      const Tooltip = ({ children, text }) =>
        h(
          "div",
          { className: "tooltip-container" },
          children,
          h("div", { className: "tooltip" }, text)
        );

      // Progress Bar Component
      const ProgressBar = ({ value, max, color = "blue", label }) =>
        h(
          "div",
          { className: "w-full" },
          label &&
            h("div", { className: "text-xs text-slate-400 mb-1" }, label),
          h(
            "div",
            { className: "progress-track" },
            h("div", {
              className: `progress-fill bg-${color}-500`,
              style: { width: `${(value / max) * 100}%` },
            })
          )
        );

      // Phase Indicator Component
      const PhaseIndicator = ({ phase, isAnnouncement }) =>
        h(
          "div",
          {
            className: `phase-indicator px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${
              isAnnouncement
                ? "bg-gradient-to-r from-amber-600 to-amber-500"
                : "bg-gradient-to-r from-red-600 to-red-500"
            }`,
          },
          isAnnouncement
            ? h(Megaphone, { className: "w-4 h-4" })
            : h(Scissors, { className: "w-4 h-4" }),
          isAnnouncement ? "ðŸ“¢ ANNOUNCEMENT PHASE" : "âœ‚ï¸ WIRE CUTTING PHASE"
        );

      // Urgency Badge Component
      const UrgencyBadge = ({ round }) => {
        const urgencyClass = `urgency-${round}`;
        const urgencyText = [
          "",
          "Calm",
          "Rising Tension",
          "High Stakes",
          "CRITICAL",
        ][round];
        const heartbeatClass = [
          "",
          "",
          "heartbeat-slow",
          "heartbeat-medium",
          "heartbeat-critical",
        ][round];

        return h(
          "div",
          {
            className: `${urgencyClass} ${heartbeatClass} flex items-center gap-2 px-3 py-1.5 rounded-lg border`,
            style: {
              borderColor: `var(--urgency-color)`,
              background: `var(--urgency-bg)`,
            },
          },
          h(Clock, {
            className: "w-4 h-4",
            style: { color: `var(--urgency-color)` },
          }),
          h(
            "span",
            {
              className: "text-sm font-semibold",
              style: { color: `var(--urgency-color)` },
            },
            urgencyText
          )
        );
      };

      // HomeScreen Component
      function HomeScreen({
        playerName,
        setPlayerName,
        inputCode,
        setInputCode,
        error,
        loading,
        createRoom,
        joinRoom,
      }) {
        return h(
          "div",
          {
            className:
              "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
          },
          h(
            "div",
            {
              className:
                "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-slate-700",
            },
            h(
              "div",
              { className: "text-center mb-8" },
              h(Timer, {
                className: "w-16 h-16 mx-auto mb-4 text-yellow-400",
              }),
              h(
                "h1",
                { className: "text-4xl font-bold text-white mb-2" },
                "Time Bomb"
              ),
              h(
                "p",
                { className: "text-slate-400" },
                "London, 1890. Defuse or detonate?"
              )
            ),
            h(
              "div",
              { className: "space-y-6" },
              h(
                "div",
                null,
                h(
                  "label",
                  { className: "block text-white mb-2 font-semibold" },
                  "Your Name"
                ),
                h("input", {
                  type: "text",
                  value: playerName,
                  onChange: (e) => setPlayerName(e.target.value),
                  placeholder: "Enter your name",
                  maxLength: 20,
                  className:
                    "w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none",
                })
              ),
              error &&
                h(
                  "div",
                  {
                    className:
                      "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm",
                  },
                  error
                ),
              h(
                "button",
                {
                  onClick: createRoom,
                  disabled: loading,
                  className:
                    "w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-blue-600 transition-all shadow-lg disabled:opacity-50",
                },
                loading ? "Creating..." : "Create Room"
              ),
              h(
                "div",
                { className: "relative" },
                h(
                  "div",
                  { className: "absolute inset-0 flex items-center" },
                  h("div", { className: "w-full border-t border-slate-600" })
                ),
                h(
                  "div",
                  { className: "relative flex justify-center text-sm" },
                  h(
                    "span",
                    { className: "px-2 bg-slate-800 text-slate-400" },
                    "OR"
                  )
                )
              ),
              h(
                "div",
                null,
                h(
                  "label",
                  { className: "block text-white mb-2 font-semibold" },
                  "Room Code"
                ),
                h("input", {
                  type: "text",
                  value: inputCode,
                  onChange: (e) => setInputCode(e.target.value.toUpperCase()),
                  placeholder: "Enter 5-character code",
                  maxLength: 5,
                  className:
                    "w-full bg-slate-700 text-white px-4 py-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none uppercase",
                })
              ),
              h(
                "button",
                {
                  onClick: joinRoom,
                  disabled: loading,
                  className:
                    "w-full bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-lg font-bold text-lg transition-all disabled:opacity-50",
                },
                loading ? "Joining..." : "Join Room"
              )
            )
          )
        );
      }

      // LobbyScreen Component
      function LobbyScreen({
        roomCode,
        playerId,
        gameState,
        copied,
        error,
        copyRoomCode,
        updatePlayerCount,
        toggleReady,
        startGame,
        leaveRoom,
      }) {
        const [isLoading, setIsLoading] = useState(false);
        const [showLeaveConfirm, setShowLeaveConfirm] = useState(false);

        const isHost = playerId === gameState.hostId;
        const allReady =
          gameState.players.every((p) => p.ready) &&
          gameState.players.length === gameState.playerCount;

        const handleLeave = async () => {
          if (isHost && !showLeaveConfirm) {
            setShowLeaveConfirm(true);
            return;
          }
          setIsLoading(true);
          await leaveRoom();
        };

        const handleStartGame = async () => {
          setIsLoading(true);
          await startGame();
          setIsLoading(false);
        };

        return h(
          "div",
          {
            className:
              "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
          },
          h(
            "div",
            {
              className:
                "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full border border-slate-700",
            },
            h(
              "div",
              { className: "text-center mb-6" },
              h(
                "h2",
                { className: "text-3xl font-bold text-white mb-4" },
                "Game Lobby"
              ),
              h(
                "div",
                { className: "bg-slate-900 rounded-lg p-4 mb-4" },
                h(
                  "div",
                  { className: "text-slate-400 text-sm mb-1" },
                  "Room Code"
                ),
                h(
                  "div",
                  { className: "flex items-center justify-center gap-2" },
                  h(
                    "div",
                    {
                      className: "text-4xl font-bold text-white tracking-wider",
                    },
                    roomCode
                  ),
                  h(
                    "button",
                    {
                      onClick: copyRoomCode,
                      className:
                        "p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-all",
                      title: "Copy code",
                    },
                    copied
                      ? h(Check, { className: "w-5 h-5 text-green-400" })
                      : h(Copy, { className: "w-5 h-5 text-slate-400" })
                  )
                ),
                h(
                  "div",
                  { className: "text-slate-400 text-sm mt-2" },
                  "Share this code with your friends!"
                )
              )
            ),
            isHost &&
              h(
                "div",
                { className: "mb-6" },
                h(
                  "label",
                  { className: "block text-white mb-3 font-semibold" },
                  h(Users, { className: "inline w-5 h-5 mr-2" }),
                  "Number of Players"
                ),
                h(
                  "div",
                  { className: "grid grid-cols-5 gap-2" },
                  [4, 5, 6, 7, 8].map((num) =>
                    h(
                      "button",
                      {
                        key: num,
                        onClick: () => updatePlayerCount(num),
                        className: `py-3 rounded-lg font-bold transition-all ${
                          gameState.playerCount === num
                            ? "bg-blue-500 text-white shadow-lg"
                            : "bg-slate-700 text-slate-300 hover:bg-slate-600"
                        }`,
                      },
                      num
                    )
                  )
                ),
                h(
                  "div",
                  {
                    className:
                      "bg-slate-900 rounded-lg p-3 mt-3 text-sm text-slate-300",
                  },
                  h(
                    "div",
                    { className: "flex justify-between" },
                    h(
                      "span",
                      { className: "flex items-center" },
                      h(Shield, {
                        className: "w-4 h-4 mr-2 text-blue-400",
                      }),
                      "Sherlock:"
                    ),
                    h(
                      "span",
                      { className: "font-bold text-blue-400" },
                      GAME_CONFIG[gameState.playerCount].sherlock
                    )
                  ),
                  h(
                    "div",
                    { className: "flex justify-between mt-1" },
                    h(
                      "span",
                      { className: "flex items-center" },
                      h(Zap, { className: "w-4 h-4 mr-2 text-red-400" }),
                      "Moriarty:"
                    ),
                    h(
                      "span",
                      { className: "font-bold text-red-400" },
                      GAME_CONFIG[gameState.playerCount].moriarty
                    )
                  )
                )
              ),
            h(
              "div",
              { className: "mb-6" },
              h(
                "div",
                { className: "flex justify-between items-center mb-3" },
                h(
                  "h3",
                  { className: "text-white font-bold" },
                  `Players (${gameState.players.length}/${gameState.playerCount})`
                )
              ),
              h(
                "div",
                { className: "space-y-2" },
                gameState.players.map((player) =>
                  h(
                    "div",
                    {
                      key: player.id,
                      className:
                        "bg-slate-700 rounded-lg p-3 flex justify-between items-center",
                    },
                    h(
                      "div",
                      { className: "flex items-center gap-2" },
                      h("div", {
                        className: `w-3 h-3 rounded-full ${
                          player.ready ? "bg-green-400" : "bg-slate-500"
                        }`,
                      }),
                      h(
                        "span",
                        { className: "text-white font-medium" },
                        player.name
                      ),
                      player.id === gameState.hostId &&
                        h(
                          "span",
                          {
                            className:
                              "text-xs bg-yellow-500 text-slate-900 px-2 py-1 rounded font-bold",
                          },
                          "HOST"
                        ),
                      player.id === playerId &&
                        h(
                          "span",
                          {
                            className:
                              "text-xs bg-blue-500 text-white px-2 py-1 rounded font-bold",
                          },
                          "YOU"
                        )
                    ),
                    h(
                      "div",
                      { className: "text-sm text-slate-400" },
                      player.ready ? "âœ“ Ready" : "Not ready"
                    )
                  )
                )
              )
            ),
            error &&
              h(
                "div",
                {
                  className:
                    "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm mb-4",
                },
                error
              ),

            // Leave confirmation for host
            showLeaveConfirm &&
              isHost &&
              h(
                "div",
                {
                  className:
                    "bg-orange-900/50 border border-orange-500 rounded-lg p-4 mb-4",
                },
                h(
                  "p",
                  { className: "text-orange-200 font-bold mb-2" },
                  "âš ï¸ Are you sure?"
                ),
                h(
                  "p",
                  { className: "text-orange-300 text-sm mb-3" },
                  "As the host, leaving will close the room for all players."
                ),
                h(
                  "div",
                  { className: "flex gap-2" },
                  h(
                    "button",
                    {
                      onClick: () => setShowLeaveConfirm(false),
                      className:
                        "flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg font-bold transition-all",
                    },
                    "Cancel"
                  ),
                  h(
                    "button",
                    {
                      onClick: handleLeave,
                      disabled: isLoading,
                      className:
                        "flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-bold transition-all disabled:opacity-50",
                    },
                    isLoading ? "Leaving..." : "Yes, Leave"
                  )
                )
              ),

            // Action buttons
            !showLeaveConfirm &&
              h(
                "div",
                { className: "flex gap-3" },
                h(
                  "button",
                  {
                    onClick: toggleReady,
                    disabled: isLoading,
                    className: `flex-1 py-3 rounded-lg font-bold transition-all ${
                      gameState.players.find((p) => p.id === playerId)?.ready
                        ? "bg-slate-600 hover:bg-slate-500 text-white"
                        : "bg-green-600 hover:bg-green-500 text-white"
                    } disabled:opacity-50`,
                  },
                  gameState.players.find((p) => p.id === playerId)?.ready
                    ? "âœ“ Ready"
                    : "ðŸŽ® Ready Up"
                ),
                isHost &&
                  h(
                    "button",
                    {
                      onClick: handleStartGame,
                      disabled: !allReady || isLoading,
                      className:
                        "flex-1 bg-gradient-to-r from-blue-600 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-blue-700 hover:to-blue-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed",
                    },
                    isLoading ? "Starting..." : "ðŸš€ Start Game"
                  ),
                h(
                  "button",
                  {
                    onClick: handleLeave,
                    disabled: isLoading,
                    className:
                      "px-6 bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg font-bold transition-all disabled:opacity-50",
                  },
                  "ðŸšª Leave"
                )
              ),

            // Helpful tips
            h(
              "div",
              { className: "mt-6 text-center" },
              !allReady &&
                gameState.players.length === gameState.playerCount &&
                h(
                  "p",
                  { className: "text-yellow-400 text-sm" },
                  "ðŸ’¡ All players must be ready to start the game"
                ),
              gameState.players.length < gameState.playerCount &&
                h(
                  "p",
                  { className: "text-slate-400 text-sm" },
                  `ðŸ‘¥ Waiting for ${
                    gameState.playerCount - gameState.players.length
                  } more player${
                    gameState.playerCount - gameState.players.length > 1
                      ? "s"
                      : ""
                  } to join...`
                )
            )
          )
        );
      }

      // GameScreen Component - Enhanced UX Design
      function GameScreen({
        gameState,
        playerId,
        myRole,
        selectedWire,
        setSelectedWire,
        gameLog,
        showLog,
        setShowLog,
        cutWire,
        showGameOverEffect,
        gameOverType,
      }) {
        const [defusingAnnounce, setDefusingAnnounce] = useState(0);
        const [bombAnnounce, setBombAnnounce] = useState(0);

        // Round transition state
        const [showRoundTransition, setShowRoundTransition] = useState(false);
        const [transitionRound, setTransitionRound] = useState(1);
        const [transitionExiting, setTransitionExiting] = useState(false);
        const [lastSeenRound, setLastSeenRound] = useState(null);

        // Detect round changes and show transition
        useEffect(() => {
          if (
            gameState &&
            gameState.round &&
            lastSeenRound !== null &&
            gameState.round > lastSeenRound
          ) {
            setTransitionRound(gameState.round);
            setShowRoundTransition(true);
            setTransitionExiting(false);

            const exitTimer = setTimeout(() => {
              setTransitionExiting(true);
            }, 1500);

            const hideTimer = setTimeout(() => {
              setShowRoundTransition(false);
            }, 1800);

            return () => {
              clearTimeout(exitTimer);
              clearTimeout(hideTimer);
            };
          }
          if (gameState && gameState.round) {
            setLastSeenRound(gameState.round);
          }
        }, [gameState?.round, lastSeenRound]);

        // Safety checks
        if (!gameState || !gameState.players || !gameState.config) {
          return h(
            "div",
            {
              className:
                "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
            },
            h(
              "div",
              { className: "text-white text-center" },
              h("div", { className: "text-4xl mb-4 animate-pulse" }, "â³"),
              h("div", { className: "text-xl" }, "Loading game...")
            )
          );
        }

        const currentPlayerObj = gameState.players[gameState.currentPlayer];
        if (!currentPlayerObj) {
          return h(
            "div",
            {
              className:
                "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
            },
            h(
              "div",
              { className: "text-white text-center" },
              h("div", { className: "text-4xl mb-4 animate-pulse" }, "â³"),
              h("div", { className: "text-xl" }, "Syncing game state...")
            )
          );
        }

        const isMyTurn = currentPlayerObj.id === playerId;
        const myPlayer = gameState.players.find((p) => p.id === playerId);
        const isHost = playerId === gameState.hostId;

        // Count my actual cards
        const myActualCards =
          myPlayer && myPlayer.wires
            ? {
                defusing: myPlayer.wires.filter(
                  (w) => w.type === "defusing" && !w.revealed
                ).length,
                bomb: myPlayer.wires.filter(
                  (w) => w.type === "bomb" && !w.revealed
                ).length,
                safe: myPlayer.wires.filter(
                  (w) => w.type === "safe" && !w.revealed
                ).length,
              }
            : { defusing: 0, bomb: 0, safe: 0 };

        // Check announcements
        const myAnnouncement =
          gameState.announcements && gameState.announcements[playerId];
        const hasAnnouncedThisRound =
          myAnnouncement &&
          myAnnouncement.round === gameState.round &&
          myAnnouncement.locked;

        const allPlayersAnnounced = gameState.players.every((p) => {
          const announcement =
            gameState.announcements && gameState.announcements[p.id];
          return (
            announcement &&
            announcement.round === gameState.round &&
            announcement.locked
          );
        });

        // Current game phase
        const currentPhase = allPlayersAnnounced ? "cutting" : "announcement";

        // Urgency level based on round
        const urgencyLevel = gameState.round;
        const urgencyClass = `urgency-${urgencyLevel}`;

        // Calculate suspicion for a player based on their announcements vs revealed cards
        const calculateSuspicion = (player) => {
          if (!gameState.announcements || !gameState.announcements[player.id])
            return 0;
          const announcement = gameState.announcements[player.id];
          if (!announcement.locked) return 0;

          // Count revealed cards for this player across all rounds
          const revealedDefusing = player.wires
            ? player.wires.filter((w) => w.type === "defusing" && w.revealed)
                .length
            : 0;
          const revealedBomb = player.wires
            ? player.wires.filter((w) => w.type === "bomb" && w.revealed).length
            : 0;

          // If they claimed fewer special cards than revealed, they're suspicious
          let suspicion = 0;
          if (revealedDefusing > announcement.defusing) suspicion += 40;
          if (revealedBomb > announcement.bomb) suspicion += 60;

          return Math.min(100, suspicion);
        };

        const announceCards = async () => {
          if (hasAnnouncedThisRound) return;
          try {
            const announcements = gameState.announcements || {};
            announcements[playerId] = {
              name: myPlayer.name,
              defusing: defusingAnnounce,
              bomb: bombAnnounce,
              round: gameState.round,
              locked: true,
            };
            await database
              .ref(`rooms/${gameState.code}/announcements`)
              .set(announcements);
          } catch (err) {
            console.error("Failed to announce cards");
          }
        };

        // Team-based background with urgency overlay
        const teamBackground =
          myRole === "sherlock"
            ? "from-slate-900 via-blue-950 to-slate-900"
            : "from-slate-900 via-red-950 to-slate-900";

        const roleClass =
          myRole === "sherlock" ? "role-sherlock" : "role-moriarty";

        // Get total claimed special cards
        const getTotalClaimed = () => {
          if (!gameState.announcements) return { defusing: 0, bomb: 0 };
          return Object.values(gameState.announcements).reduce(
            (acc, ann) => {
              if (ann.round === gameState.round && ann.locked) {
                acc.defusing += ann.defusing || 0;
                acc.bomb += ann.bomb || 0;
              }
              return acc;
            },
            { defusing: 0, bomb: 0 }
          );
        };

        const totalClaimed = getTotalClaimed();

        return h(
          "div",
          {
            className: `min-h-screen bg-gradient-to-br ${teamBackground} p-2 sm:p-4 ${urgencyClass}`,
          },

          // ==========================================
          // ROUND TRANSITION OVERLAY
          // ==========================================
          showRoundTransition &&
            h(
              "div",
              {
                className: `fixed inset-0 z-50 flex items-center justify-center bg-black/90 ${
                  transitionExiting
                    ? "round-transition-exit"
                    : "round-transition-enter"
                }`,
              },
              h(
                "div",
                { className: "text-center px-4" },
                h(
                  "div",
                  {
                    className:
                      "text-slate-400 text-xl mb-2 round-number-animate",
                  },
                  transitionRound > 1
                    ? `Round ${transitionRound - 1} Complete`
                    : "Game Starting"
                ),
                h(
                  "div",
                  {
                    className: `text-6xl md:text-8xl font-bold mb-4 round-number-animate ${
                      transitionRound >= 3
                        ? "text-orange-400"
                        : transitionRound === 4
                        ? "text-red-400"
                        : "text-white"
                    }`,
                  },
                  `Round ${transitionRound}`
                ),
                h(
                  "div",
                  {
                    className:
                      "text-amber-400 text-lg round-number-animate mb-2",
                  },
                  "ðŸ”„ Cards redistributed!"
                ),
                h(
                  "div",
                  { className: "round-number-animate" },
                  transitionRound === 4
                    ? h(
                        "span",
                        { className: "text-red-400 font-bold text-xl" },
                        "âš ï¸ FINAL ROUND - Last chance!"
                      )
                    : h(
                        "span",
                        { className: "text-slate-500" },
                        `${4 - transitionRound} round${
                          4 - transitionRound !== 1 ? "s" : ""
                        } remaining`
                      )
                ),
                transitionRound >= 3 &&
                  h(
                    "div",
                    {
                      className:
                        "mt-4 text-orange-300 text-sm round-number-animate",
                    },
                    "ðŸ”¥ Tension is rising..."
                  )
              )
            ),

          // ==========================================
          // MAIN GAME CONTENT
          // ==========================================
          h(
            "div",
            { className: "max-w-6xl mx-auto" },

            // ==========================================
            // TOP HEADER - Status Bar with Phase Indicator
            // ==========================================
            h(
              "div",
              {
                className: `bg-slate-800/90 backdrop-blur-sm rounded-xl p-3 sm:p-4 mb-2 sm:mb-4 border border-slate-700 mobile-header ${
                  currentPhase === "announcement"
                    ? "phase-announcement"
                    : "phase-cutting"
                } phase-bar`,
              },
              // Phase indicator and urgency
              h(
                "div",
                {
                  className:
                    "flex flex-wrap gap-2 sm:gap-3 justify-between items-center mb-2 sm:mb-4",
                },
                h(PhaseIndicator, {
                  phase: currentPhase,
                  isAnnouncement: currentPhase === "announcement",
                }),
                h(UrgencyBadge, { round: gameState.round })
              ),

              // Main stats row
              h(
                "div",
                {
                  className:
                    "flex flex-wrap gap-2 sm:gap-4 justify-between items-center mobile-stats",
                },
                h(
                  "div",
                  { className: "flex items-center gap-4 flex-wrap" },
                  // Role badge
                  h(
                    "div",
                    {
                      className: `role-card px-4 py-2 rounded-lg font-bold flex items-center gap-2 ${roleClass}`,
                    },
                    myRole === "sherlock"
                      ? h(Shield, { className: "w-5 h-5" })
                      : h(Zap, { className: "w-5 h-5" }),
                    h(
                      "span",
                      { className: "text-white" },
                      myRole === "sherlock" ? "Sherlock" : "Moriarty"
                    )
                  ),
                  // Round counter
                  h(
                    Tooltip,
                    {
                      text: `${4 - gameState.round} rounds remaining to defuse`,
                    },
                    h(
                      "div",
                      {
                        className:
                          "text-white bg-slate-700/50 px-3 py-2 rounded-lg",
                      },
                      h(
                        "div",
                        { className: "text-xs text-slate-400" },
                        "Round"
                      ),
                      h(
                        "div",
                        {
                          className: `text-xl font-bold ${
                            gameState.round >= 3 ? "text-orange-400" : ""
                          }`,
                        },
                        `${gameState.round}/4`
                      )
                    )
                  ),
                  // Defusing progress
                  h(
                    Tooltip,
                    {
                      text: `Find ${
                        gameState.config.defusing - gameState.defusingFound
                      } more to win!`,
                    },
                    h(
                      "div",
                      {
                        className:
                          "text-white bg-slate-700/50 px-3 py-2 rounded-lg",
                      },
                      h(
                        "div",
                        { className: "text-xs text-slate-400" },
                        "Defusing Found"
                      ),
                      h(
                        "div",
                        { className: "text-xl font-bold text-blue-400" },
                        `${gameState.defusingFound}/${gameState.config.defusing}`
                      )
                    )
                  )
                ),
                // Current turn indicator
                h(
                  "div",
                  {
                    className: `text-right px-4 py-2 rounded-lg ${
                      isMyTurn
                        ? "bg-amber-500/20 border border-amber-500"
                        : "bg-slate-700/50"
                    }`,
                  },
                  h(
                    "div",
                    { className: "text-xs text-slate-400" },
                    "Current Turn"
                  ),
                  h(
                    "div",
                    {
                      className: `text-xl font-bold ${
                        isMyTurn ? "text-amber-400" : "text-white"
                      }`,
                    },
                    currentPlayerObj.name
                  ),
                  isMyTurn &&
                    h(
                      "div",
                      { className: "text-xs text-amber-300 mt-1" },
                      "âœ‚ï¸ Choose a wire to cut!"
                    )
                )
              ),

              // ==========================================
              // PHASE-SPECIFIC CONTENT
              // ==========================================
              currentPhase === "announcement"
                ? h(
                    "div",
                    {
                      className:
                        "mt-2 sm:mt-4 bg-amber-900/40 border border-amber-600 rounded-xl p-3 sm:p-4 mobile-phase-content",
                    },
                    h(
                      "div",
                      {
                        className:
                          "flex flex-wrap items-center justify-between gap-2 sm:gap-3 mb-2 sm:mb-4",
                      },
                      h(
                        "div",
                        { className: "flex items-center gap-2" },
                        h(Megaphone, {
                          className: "w-4 h-4 sm:w-5 sm:h-5 text-amber-400",
                        }),
                        h(
                          "span",
                          {
                            className:
                              "text-amber-300 font-bold text-sm sm:text-base",
                          },
                          "Announcement Phase"
                        )
                      ),
                      hasAnnouncedThisRound &&
                        h(
                          "span",
                          {
                            className:
                              "text-green-400 text-xs sm:text-sm flex items-center gap-1",
                          },
                          h(Check, { className: "w-3 h-3 sm:w-4 sm:h-4" }),
                          "Done!"
                        )
                    ),
                    h(
                      "p",
                      {
                        className:
                          "text-amber-200/80 text-xs sm:text-sm mb-2 sm:mb-4",
                      },
                      "Each player must announce what cards they claim to have. You can lie!"
                    ),

                    // INLINE ANNOUNCEMENT FORM (not announced yet)
                    !hasAnnouncedThisRound &&
                      h(
                        "div",
                        {
                          className:
                            "bg-slate-800/80 rounded-xl p-3 sm:p-4 mb-3 sm:mb-4 border-2 border-amber-500 pulse-attention mobile-announcement",
                        },
                        // Your actual cards (private reminder)
                        h(
                          "div",
                          {
                            className:
                              "bg-slate-900/70 rounded-lg p-2 sm:p-3 mb-3 sm:mb-4 border border-slate-700",
                          },
                          h(
                            "div",
                            { className: "flex items-center gap-2 mb-2" },
                            h(Eye, {
                              className: "w-3 h-3 sm:w-4 sm:h-4 text-slate-400",
                            }),
                            h(
                              "span",
                              {
                                className:
                                  "text-slate-400 text-xs uppercase tracking-wide font-semibold",
                              },
                              "Your Cards"
                            )
                          ),
                          h(
                            "div",
                            {
                              className:
                                "flex justify-center gap-4 sm:gap-6 mobile-cards-display",
                            },
                            h(
                              "div",
                              { className: "text-center" },
                              h("div", { className: "text-2xl mb-1" }, "âœ‚ï¸"),
                              h(
                                "div",
                                {
                                  className: "text-blue-400 font-bold text-lg",
                                },
                                myActualCards.defusing
                              ),
                              h(
                                "div",
                                { className: "text-slate-500 text-xs" },
                                "Defusing"
                              )
                            ),
                            h(
                              "div",
                              { className: "text-center" },
                              h("div", { className: "text-2xl mb-1" }, "ðŸ’£"),
                              h(
                                "div",
                                { className: "text-red-400 font-bold text-lg" },
                                myActualCards.bomb
                              ),
                              h(
                                "div",
                                { className: "text-slate-500 text-xs" },
                                "Bomb"
                              )
                            ),
                            h(
                              "div",
                              { className: "text-center" },
                              h("div", { className: "text-2xl mb-1" }, "âœ“"),
                              h(
                                "div",
                                {
                                  className: "text-slate-400 font-bold text-lg",
                                },
                                myActualCards.safe
                              ),
                              h(
                                "div",
                                { className: "text-slate-500 text-xs" },
                                "Safe"
                              )
                            )
                          )
                        ),
                        // Claim inputs
                        h(
                          "div",
                          { className: "mb-4" },
                          h(
                            "div",
                            { className: "text-center mb-2" },
                            h(
                              "span",
                              { className: "text-white font-semibold" },
                              "ðŸ“¢ What will you claim?"
                            ),
                            h(
                              "p",
                              { className: "text-slate-400 text-xs mt-1" },
                              myRole === "sherlock"
                                ? "Help your teamâ€”or hide info from Moriarty!"
                                : "Mislead the detectivesâ€”claim whatever serves your plan!"
                            )
                          ),
                          h(
                            "div",
                            {
                              className: "flex justify-center gap-4 flex-wrap",
                            },
                            // Defusing claim
                            h(
                              "div",
                              {
                                className:
                                  "bg-blue-900/40 rounded-lg p-3 border border-blue-700",
                              },
                              h(
                                "div",
                                {
                                  className:
                                    "text-blue-300 text-xs mb-2 text-center font-bold",
                                },
                                "âœ‚ï¸ Defusing"
                              ),
                              h(
                                "div",
                                {
                                  className:
                                    "flex items-center justify-center gap-2",
                                },
                                h(
                                  "button",
                                  {
                                    onClick: () =>
                                      setDefusingAnnounce(
                                        Math.max(0, defusingAnnounce - 1)
                                      ),
                                    className:
                                      "bg-blue-700 hover:bg-blue-600 text-white w-8 h-8 rounded-full font-bold text-lg transition-all hover:scale-110",
                                  },
                                  "âˆ’"
                                ),
                                h(
                                  "div",
                                  {
                                    className:
                                      "text-2xl font-bold text-white w-8 text-center",
                                  },
                                  defusingAnnounce
                                ),
                                h(
                                  "button",
                                  {
                                    onClick: () =>
                                      setDefusingAnnounce(
                                        Math.min(5, defusingAnnounce + 1)
                                      ),
                                    className:
                                      "bg-blue-700 hover:bg-blue-600 text-white w-8 h-8 rounded-full font-bold text-lg transition-all hover:scale-110",
                                  },
                                  "+"
                                )
                              )
                            ),
                            // Bomb claim
                            h(
                              "div",
                              {
                                className:
                                  "bg-red-900/40 rounded-lg p-3 border border-red-700",
                              },
                              h(
                                "div",
                                {
                                  className:
                                    "text-red-300 text-xs mb-2 text-center font-bold",
                                },
                                "ðŸ’£ Bomb"
                              ),
                              h(
                                "div",
                                {
                                  className:
                                    "flex items-center justify-center gap-2",
                                },
                                h(
                                  "button",
                                  {
                                    onClick: () =>
                                      setBombAnnounce(
                                        Math.max(0, bombAnnounce - 1)
                                      ),
                                    className:
                                      "bg-red-700 hover:bg-red-600 text-white w-8 h-8 rounded-full font-bold text-lg transition-all hover:scale-110",
                                  },
                                  "âˆ’"
                                ),
                                h(
                                  "div",
                                  {
                                    className:
                                      "text-2xl font-bold text-white w-8 text-center",
                                  },
                                  bombAnnounce
                                ),
                                h(
                                  "button",
                                  {
                                    onClick: () =>
                                      setBombAnnounce(
                                        Math.min(1, bombAnnounce + 1)
                                      ),
                                    className:
                                      "bg-red-700 hover:bg-red-600 text-white w-8 h-8 rounded-full font-bold text-lg transition-all hover:scale-110",
                                  },
                                  "+"
                                )
                              )
                            )
                          )
                        ),
                        // Submit button
                        h(
                          "button",
                          {
                            onClick: announceCards,
                            className:
                              "w-full bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-slate-900 py-3 rounded-lg font-bold text-base transition-all hover:scale-[1.02] shadow-lg flex items-center justify-center gap-2",
                          },
                          h(Megaphone, { className: "w-5 h-5" }),
                          "ðŸ”’ Lock In My Claim"
                        )
                      ),

                    // AFTER ANNOUNCED: Show your real cards reminder
                    hasAnnouncedThisRound &&
                      h(
                        "div",
                        {
                          className:
                            "bg-slate-800/60 rounded-xl p-4 mb-4 border border-slate-600",
                        },
                        h(
                          "div",
                          { className: "flex items-center gap-2 mb-3" },
                          h(Eye, { className: "w-4 h-4 text-slate-400" }),
                          h(
                            "span",
                            {
                              className:
                                "text-slate-400 text-xs uppercase tracking-wide font-semibold",
                            },
                            "Your Real Cards (reminder)"
                          )
                        ),
                        h(
                          "div",
                          { className: "flex justify-center gap-6" },
                          h(
                            "div",
                            { className: "text-center" },
                            h("div", { className: "text-2xl mb-1" }, "âœ‚ï¸"),
                            h(
                              "div",
                              { className: "text-blue-400 font-bold text-lg" },
                              myActualCards.defusing
                            ),
                            h(
                              "div",
                              { className: "text-slate-500 text-xs" },
                              "Defusing"
                            )
                          ),
                          h(
                            "div",
                            { className: "text-center" },
                            h("div", { className: "text-2xl mb-1" }, "ðŸ’£"),
                            h(
                              "div",
                              { className: "text-red-400 font-bold text-lg" },
                              myActualCards.bomb
                            ),
                            h(
                              "div",
                              { className: "text-slate-500 text-xs" },
                              "Bomb"
                            )
                          ),
                          h(
                            "div",
                            { className: "text-center" },
                            h("div", { className: "text-2xl mb-1" }, "âœ“"),
                            h(
                              "div",
                              { className: "text-slate-400 font-bold text-lg" },
                              myActualCards.safe
                            ),
                            h(
                              "div",
                              { className: "text-slate-500 text-xs" },
                              "Safe"
                            )
                          )
                        ),
                        // Show what you claimed vs reality
                        myAnnouncement &&
                          h(
                            "div",
                            {
                              className: "mt-3 pt-3 border-t border-slate-700",
                            },
                            h(
                              "div",
                              {
                                className:
                                  "text-xs text-slate-400 text-center mb-2",
                              },
                              "You claimed:"
                            ),
                            h(
                              "div",
                              { className: "flex justify-center gap-4" },
                              h(
                                "span",
                                {
                                  className: `text-sm px-2 py-1 rounded ${
                                    myAnnouncement.defusing ===
                                    myActualCards.defusing
                                      ? "bg-green-800/50 text-green-300"
                                      : "bg-amber-800/50 text-amber-300"
                                  }`,
                                },
                                `âœ‚ï¸ ${myAnnouncement.defusing} ${
                                  myAnnouncement.defusing ===
                                  myActualCards.defusing
                                    ? "âœ“"
                                    : "(lied)"
                                }`
                              ),
                              h(
                                "span",
                                {
                                  className: `text-sm px-2 py-1 rounded ${
                                    myAnnouncement.bomb === myActualCards.bomb
                                      ? "bg-green-800/50 text-green-300"
                                      : "bg-amber-800/50 text-amber-300"
                                  }`,
                                },
                                `ðŸ’£ ${myAnnouncement.bomb} ${
                                  myAnnouncement.bomb === myActualCards.bomb
                                    ? "âœ“"
                                    : "(lied)"
                                }`
                              )
                            )
                          )
                      ),

                    // Announcement status grid
                    h(
                      "div",
                      {
                        className:
                          "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2",
                      },
                      gameState.players.map((p) => {
                        const pAnn =
                          gameState.announcements &&
                          gameState.announcements[p.id];
                        const pHasAnnounced =
                          pAnn && pAnn.round === gameState.round && pAnn.locked;
                        const isMe = p.id === playerId;
                        return h(
                          "div",
                          {
                            key: p.id,
                            className: `rounded-lg p-2 text-center transition-all ${
                              pHasAnnounced
                                ? "bg-green-900/50 border border-green-700"
                                : "bg-slate-700/50 border border-slate-600"
                            } ${isMe ? "ring-2 ring-blue-500" : ""}`,
                          },
                          h(
                            "div",
                            {
                              className:
                                "text-white text-sm font-medium truncate",
                            },
                            p.name,
                            isMe &&
                              h(
                                "span",
                                { className: "text-blue-400 text-xs ml-1" },
                                "(You)"
                              )
                          ),
                          pHasAnnounced
                            ? h(
                                "div",
                                { className: "flex justify-center gap-2 mt-1" },
                                h(
                                  "span",
                                  {
                                    className:
                                      "text-xs bg-blue-800/60 text-blue-300 px-1.5 py-0.5 rounded",
                                  },
                                  `âœ‚ï¸${pAnn.defusing}`
                                ),
                                h(
                                  "span",
                                  {
                                    className:
                                      "text-xs bg-red-800/60 text-red-300 px-1.5 py-0.5 rounded",
                                  },
                                  `ðŸ’£${pAnn.bomb}`
                                )
                              )
                            : h(
                                "div",
                                {
                                  className:
                                    "text-xs text-slate-400 mt-1 animate-pulse",
                                },
                                "â³ Thinking..."
                              )
                        );
                      })
                    )
                  )
                : h(
                    "div",
                    {
                      className:
                        "mt-4 bg-green-900/40 border border-green-600 rounded-xl p-4",
                    },
                    h(
                      "div",
                      { className: "flex items-center gap-2 mb-2" },
                      h(Scissors, { className: "w-5 h-5 text-green-400" }),
                      h(
                        "span",
                        { className: "text-green-300 font-bold" },
                        "Wire Cutting Phase"
                      )
                    ),
                    h(
                      "p",
                      { className: "text-green-200/80 text-sm" },
                      isMyTurn
                        ? "ðŸŽ¯ It's your turn! Select a wire from another player to cut."
                        : `Waiting for ${currentPlayerObj.name} to cut a wire...`
                    ),
                    // Your real cards reminder during cutting phase
                    h(
                      "div",
                      {
                        className:
                          "mt-3 bg-slate-800/60 rounded-lg p-3 border border-slate-700",
                      },
                      h(
                        "div",
                        { className: "flex items-center gap-2 mb-2" },
                        h(Eye, { className: "w-4 h-4 text-slate-400" }),
                        h(
                          "span",
                          {
                            className:
                              "text-slate-400 text-xs uppercase tracking-wide font-semibold",
                          },
                          "Your Real Cards"
                        )
                      ),
                      h(
                        "div",
                        { className: "flex justify-center gap-6" },
                        h(
                          "div",
                          { className: "text-center" },
                          h("div", { className: "text-xl mb-0.5" }, "âœ‚ï¸"),
                          h(
                            "div",
                            { className: "text-blue-400 font-bold" },
                            myActualCards.defusing
                          ),
                          h(
                            "div",
                            { className: "text-slate-500 text-xs" },
                            "Defusing"
                          )
                        ),
                        h(
                          "div",
                          { className: "text-center" },
                          h("div", { className: "text-xl mb-0.5" }, "ðŸ’£"),
                          h(
                            "div",
                            { className: "text-red-400 font-bold" },
                            myActualCards.bomb
                          ),
                          h(
                            "div",
                            { className: "text-slate-500 text-xs" },
                            "Bomb"
                          )
                        ),
                        h(
                          "div",
                          { className: "text-center" },
                          h("div", { className: "text-xl mb-0.5" }, "âœ“"),
                          h(
                            "div",
                            { className: "text-slate-400 font-bold" },
                            myActualCards.safe
                          ),
                          h(
                            "div",
                            { className: "text-slate-500 text-xs" },
                            "Safe"
                          )
                        )
                      ),
                      // What you claimed
                      myAnnouncement &&
                        myAnnouncement.round === gameState.round &&
                        h(
                          "div",
                          {
                            className:
                              "mt-2 pt-2 border-t border-slate-700 flex justify-center gap-3 text-xs",
                          },
                          h(
                            "span",
                            { className: "text-slate-400" },
                            "You claimed:"
                          ),
                          h(
                            "span",
                            {
                              className:
                                myAnnouncement.defusing ===
                                myActualCards.defusing
                                  ? "text-green-400"
                                  : "text-amber-400",
                            },
                            `âœ‚ï¸ ${myAnnouncement.defusing}${
                              myAnnouncement.defusing !== myActualCards.defusing
                                ? " (lied)"
                                : ""
                            }`
                          ),
                          h(
                            "span",
                            {
                              className:
                                myAnnouncement.bomb === myActualCards.bomb
                                  ? "text-green-400"
                                  : "text-amber-400",
                            },
                            `ðŸ’£ ${myAnnouncement.bomb}${
                              myAnnouncement.bomb !== myActualCards.bomb
                                ? " (lied)"
                                : ""
                            }`
                          )
                        )
                    ),
                    // Summary of claims
                    allPlayersAnnounced &&
                      h(
                        "div",
                        { className: "mt-3 flex flex-wrap gap-4 text-sm" },
                        h(
                          "div",
                          { className: "flex items-center gap-2" },
                          h(Brain, { className: "w-4 h-4 text-slate-400" }),
                          h(
                            "span",
                            { className: "text-slate-400" },
                            "Total claimed:"
                          ),
                          h(
                            "span",
                            { className: "text-blue-400 font-semibold" },
                            `âœ‚ï¸ ${totalClaimed.defusing} defusing`
                          ),
                          h("span", { className: "text-slate-500" }, "â€¢"),
                          h(
                            "span",
                            { className: "text-red-400 font-semibold" },
                            `ðŸ’£ ${totalClaimed.bomb} bomb`
                          )
                        ),
                        totalClaimed.defusing !==
                          gameState.config.defusing - gameState.defusingFound &&
                          h(
                            "span",
                            { className: "text-amber-400 text-xs" },
                            "âš ï¸ Claims don't match expected!"
                          )
                      )
                  ),

              // Game log toggle (host only)
              isHost &&
                h(
                  "button",
                  {
                    onClick: () => setShowLog(!showLog),
                    className:
                      "mt-4 w-full bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded-lg text-sm transition-all flex items-center justify-center gap-2",
                  },
                  h(History, { className: "w-4 h-4" }),
                  showLog ? "Hide Game Log" : "Show Game Log"
                ),
              showLog &&
                gameLog.length > 0 &&
                h(
                  "div",
                  {
                    className:
                      "mt-3 bg-slate-900/70 rounded-lg p-3 max-h-40 overflow-y-auto",
                  },
                  gameLog
                    .slice(-10)
                    .reverse()
                    .map((entry, idx) =>
                      h(
                        "div",
                        {
                          key: idx,
                          className:
                            "text-slate-300 text-xs py-1 border-b border-slate-800 last:border-0",
                        },
                        entry.message
                      )
                    )
                )
            ),

            // ==========================================
            // PLAYER CARDS GRID - Enhanced
            // ==========================================
            h(
              "div",
              {
                className:
                  "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-4 mt-2 sm:mt-4 mobile-player-grid",
              },
              gameState.players
                .filter((player) => player.wires && Array.isArray(player.wires))
                .map((player) => {
                  const isCurrentPlayer = currentPlayerObj.id === player.id;
                  const isMe = player.id === playerId;
                  const playerAnn =
                    gameState.announcements &&
                    gameState.announcements[player.id];
                  const hasPlayerAnnounced =
                    playerAnn &&
                    playerAnn.round === gameState.round &&
                    playerAnn.locked;
                  const suspicionLevel = calculateSuspicion(player);
                  const unrevealedCount = player.wires.filter(
                    (w) => !w.revealed
                  ).length;

                  return h(
                    "div",
                    {
                      key: player.id,
                      className: `bg-slate-800/90 backdrop-blur-sm rounded-xl p-3 sm:p-4 border-2 transition-all relative mobile-player-card ${
                        isCurrentPlayer
                          ? "player-spotlight border-amber-400"
                          : "border-slate-700 hover:border-slate-600"
                      } ${isMe ? "ring-2 ring-blue-500/50" : ""}`,
                    },
                    // Player header
                    h(
                      "div",
                      { className: "flex flex-col gap-2 mb-2 sm:mb-3" },
                      h(
                        "div",
                        { className: "flex justify-between items-start" },
                        h(
                          "div",
                          {
                            className: "flex items-center gap-2 flex-1 min-w-0",
                          },
                          h(
                            "h3",
                            {
                              className:
                                "text-white font-bold text-lg truncate",
                            },
                            player.name
                          ),
                          isMe &&
                            h(
                              "span",
                              {
                                className:
                                  "text-xs text-blue-400 font-semibold",
                              },
                              "(You)"
                            )
                        ),
                        h(
                          "span",
                          {
                            className:
                              "text-slate-400 text-sm whitespace-nowrap",
                          },
                          `${unrevealedCount} wires`
                        )
                      ),
                      // Announcement display
                      hasPlayerAnnounced
                        ? h(
                            "div",
                            { className: "flex items-center gap-2 flex-wrap" },
                            h(
                              "span",
                              {
                                className:
                                  "announcement-badge bg-blue-900/60 text-blue-300 border border-blue-700",
                              },
                              `âœ‚ï¸ ${playerAnn.defusing} defusing`
                            ),
                            h(
                              "span",
                              {
                                className:
                                  "announcement-badge bg-red-900/60 text-red-300 border border-red-700",
                              },
                              `ðŸ’£ ${playerAnn.bomb} bomb`
                            )
                          )
                        : h(
                            "div",
                            null,
                            h(
                              "span",
                              {
                                className:
                                  "announcement-badge bg-slate-700 text-slate-400",
                              },
                              "â³ Awaiting announcement..."
                            )
                          ),
                      // Suspicion meter (if any suspicious activity detected)
                      suspicionLevel > 0 &&
                        h(
                          "div",
                          { className: "mt-1" },
                          h(
                            Tooltip,
                            { text: "Claims don't match revealed cards!" },
                            h(
                              "div",
                              { className: "flex items-center gap-2" },
                              h(Eye, { className: "w-3 h-3 text-red-400" }),
                              h(
                                "div",
                                { className: "suspicion-meter flex-1" },
                                h("div", {
                                  className: `suspicion-fill ${
                                    suspicionLevel > 50
                                      ? "suspicion-high"
                                      : suspicionLevel > 25
                                      ? "suspicion-medium"
                                      : "suspicion-low"
                                  }`,
                                  style: { width: `${suspicionLevel}%` },
                                })
                              ),
                              h(
                                "span",
                                { className: "text-xs text-red-400" },
                                "Suspicious"
                              )
                            )
                          )
                        )
                    ),
                    // Wire grid
                    h(
                      "div",
                      { className: "grid grid-cols-5 gap-1 sm:gap-2" },
                      player.wires.map((wire) => {
                        const canCut =
                          isMyTurn &&
                          !isMe &&
                          !wire.revealed &&
                          allPlayersAnnounced;
                        const isSelected =
                          selectedWire?.playerId === player.id &&
                          selectedWire?.wireId === wire.id;
                        return h(
                          "button",
                          {
                            key: wire.id,
                            onClick: () =>
                              canCut &&
                              setSelectedWire({
                                playerId: player.id,
                                wireId: wire.id,
                              }),
                            disabled: !canCut,
                            className: `aspect-square rounded-lg transition-all text-base sm:text-xl flex items-center justify-center mobile-wire ${
                              wire.revealed
                                ? wire.type === "bomb"
                                  ? "bg-red-500 text-white shadow-lg shadow-red-500/30"
                                  : wire.type === "defusing"
                                  ? "bg-blue-500 text-white shadow-lg shadow-blue-500/30"
                                  : "bg-slate-600 text-slate-400"
                                : isSelected
                                ? "wire-selected bg-amber-500 shadow-lg shadow-amber-500/50 cursor-pointer"
                                : canCut
                                ? "wire-selectable bg-slate-700 hover:bg-slate-600 cursor-pointer hover:scale-105 border-2 border-transparent hover:border-amber-500/50"
                                : "bg-slate-700/50 cursor-not-allowed opacity-40"
                            }`,
                          },
                          wire.revealed
                            ? wire.type === "bomb"
                              ? "ðŸ’£"
                              : wire.type === "defusing"
                              ? "âœ‚ï¸"
                              : "âœ“"
                            : isSelected
                            ? "âœ‚ï¸"
                            : "?"
                        );
                      })
                    )
                  );
                })
            ),

            // ==========================================
            // CUT WIRE CONFIRMATION BUTTON
            // ==========================================
            selectedWire &&
              isMyTurn &&
              h(
                "div",
                {
                  className:
                    "fixed bottom-4 sm:bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-[90%] sm:w-auto",
                },
                h(
                  "button",
                  {
                    onClick: () =>
                      cutWire(selectedWire.playerId, selectedWire.wireId),
                    className:
                      "cut-confirm-btn mobile-cut-btn w-full sm:w-auto bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-slate-900 px-6 sm:px-10 py-3 sm:py-4 rounded-full font-bold text-base sm:text-lg shadow-2xl transition-all hover:scale-105 flex items-center justify-center gap-2 sm:gap-3",
                  },
                  h(Scissors, { className: "w-5 h-5 sm:w-6 sm:h-6" }),
                  "Cut Wire",
                  h(
                    "span",
                    {
                      className:
                        "text-amber-900/60 text-xs sm:text-sm hidden sm:inline",
                    },
                    "from"
                  ),
                  h(
                    "span",
                    { className: "font-bold" },
                    gameState.players.find(
                      (p) => p.id === selectedWire.playerId
                    )?.name
                  )
                )
              ),

            // ==========================================
            // WIRE TYPES LEGEND WITH CONTEXTUAL INFO
            // ==========================================
            h(
              "div",
              {
                className:
                  "mt-3 sm:mt-6 bg-slate-800/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 border border-slate-700 mb-16 sm:mb-20 mobile-legend",
              },
              h(
                "div",
                { className: "flex items-center justify-between mb-2 sm:mb-3" },
                h(
                  "h4",
                  {
                    className:
                      "text-white font-bold flex items-center gap-2 text-sm sm:text-base legend-title",
                  },
                  h(Info, {
                    className: "w-3 h-3 sm:w-4 sm:h-4 text-slate-400",
                  }),
                  "Wire Types"
                ),
                h(
                  "div",
                  { className: "text-xs text-slate-400" },
                  `${gameState.config.defusing} defusing â€¢ 1 bomb â€¢ ${gameState.config.wires} safe`
                )
              ),
              h(
                "div",
                { className: "grid grid-cols-3 gap-4 text-sm" },
                h(
                  "div",
                  {
                    className:
                      "flex items-center gap-3 bg-slate-700/30 p-2 rounded-lg",
                  },
                  h(
                    "div",
                    {
                      className:
                        "w-10 h-10 bg-slate-600 rounded-lg flex items-center justify-center text-lg",
                    },
                    "âœ“"
                  ),
                  h(
                    "div",
                    null,
                    h(
                      "div",
                      { className: "text-slate-300 font-semibold" },
                      "Safe Wire"
                    ),
                    h(
                      "div",
                      { className: "text-slate-500 text-xs" },
                      "No effect"
                    )
                  )
                ),
                h(
                  "div",
                  {
                    className:
                      "flex items-center gap-3 bg-blue-900/30 p-2 rounded-lg border border-blue-800/50",
                  },
                  h(
                    "div",
                    {
                      className:
                        "w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-lg",
                    },
                    "âœ‚ï¸"
                  ),
                  h(
                    "div",
                    null,
                    h(
                      "div",
                      { className: "text-blue-300 font-semibold" },
                      "Defusing"
                    ),
                    h(
                      "div",
                      { className: "text-blue-400/70 text-xs" },
                      "Find all to win!"
                    )
                  )
                ),
                h(
                  "div",
                  {
                    className:
                      "flex items-center gap-3 bg-red-900/30 p-2 rounded-lg border border-red-800/50",
                  },
                  h(
                    "div",
                    {
                      className:
                        "w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center text-lg",
                    },
                    "ðŸ’£"
                  ),
                  h(
                    "div",
                    null,
                    h(
                      "div",
                      { className: "text-red-300 font-semibold" },
                      "BOMB"
                    ),
                    h(
                      "div",
                      { className: "text-red-400/70 text-xs" },
                      "Instant loss!"
                    )
                  )
                )
              )
            )
          ),

          // ==========================================
          // GAME OVER EFFECT OVERLAY
          // ==========================================
          showGameOverEffect &&
            h(
              "div",
              {
                className: `fixed inset-0 z-50 flex items-center justify-center ${
                  gameOverType === "bomb"
                    ? "explosion-overlay"
                    : "victory-overlay"
                }`,
              },
              h(
                "div",
                { className: "text-center" },
                gameOverType === "bomb"
                  ? h(
                      "div",
                      null,
                      h("div", { className: "text-8xl bomb-explode" }, "ðŸ’£"),
                      h(
                        "div",
                        {
                          className:
                            "text-4xl md:text-6xl font-bold text-red-500 mt-8 screen-shake",
                        },
                        "BOOM!"
                      ),
                      h(
                        "div",
                        { className: "text-xl text-orange-400 mt-4" },
                        "The bomb exploded!"
                      ),
                      h(
                        "div",
                        { className: "text-lg text-red-300 mt-2" },
                        "Big Ben has been destroyed..."
                      )
                    )
                  : h(
                      "div",
                      null,
                      h("div", { className: "text-8xl defuse-success" }, "âœ‚ï¸"),
                      h(
                        "div",
                        {
                          className:
                            "text-4xl md:text-6xl font-bold text-blue-400 mt-8",
                        },
                        "DEFUSED!"
                      ),
                      h(
                        "div",
                        { className: "text-xl text-green-400 mt-4" },
                        "All wires have been cut!"
                      ),
                      h(
                        "div",
                        { className: "text-lg text-blue-300 mt-2" },
                        "London is saved!"
                      )
                    )
              )
            )
        );
      }

      // EndScreen Component
      function EndScreen({
        gameState,
        myRole,
        playerId,
        playAgain,
        leaveRoom,
        error,
        roomCode,
      }) {
        const [isLoading, setIsLoading] = useState(false);
        const [showLeaveConfirm, setShowLeaveConfirm] = useState(false);

        const isWinner =
          (gameState.winner === "sherlock" && myRole === "sherlock") ||
          (gameState.winner === "moriarty" && myRole === "moriarty");
        const isHost = playerId === gameState.hostId;

        const handlePlayAgain = async () => {
          setIsLoading(true);
          await playAgain();
          setIsLoading(false);
        };

        const handleLeave = async () => {
          if (isHost && !showLeaveConfirm) {
            setShowLeaveConfirm(true);
            return;
          }
          setIsLoading(true);
          await leaveRoom();
        };

        return h(
          "div",
          {
            className:
              "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
          },
          h(
            "div",
            {
              className:
                "bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-slate-700 text-center",
            },
            h(
              "div",
              { className: "mb-6" },
              gameState.winner === "sherlock"
                ? h(Shield, {
                    className:
                      "w-20 h-20 mx-auto text-blue-400 mb-4 animate-pulse",
                  })
                : h(Zap, {
                    className:
                      "w-20 h-20 mx-auto text-red-400 mb-4 animate-pulse",
                  })
            ),
            h(
              "h2",
              { className: "text-3xl font-bold text-white mb-4" },
              gameState.winner === "sherlock"
                ? "Bomb Defused!"
                : "Big Ben Destroyed!"
            ),
            h(
              "p",
              { className: "text-xl mb-6 text-slate-300" },
              h(
                "span",
                {
                  className: `font-bold ${
                    gameState.winner === "sherlock"
                      ? "text-blue-400"
                      : "text-red-400"
                  }`,
                },
                gameState.winner === "sherlock"
                  ? "Sherlock's Team Wins!"
                  : "Moriarty's Team Wins!"
              )
            ),
            h(
              "div",
              { className: "bg-slate-900 rounded-lg p-4 mb-6" },
              h(
                "p",
                {
                  className: `text-lg font-bold ${
                    isWinner ? "text-green-400" : "text-orange-400"
                  }`,
                },
                isWinner ? "ðŸŽ‰ You Won!" : "ðŸ˜” You Lost"
              ),
              h(
                "p",
                { className: "text-slate-400 mt-2" },
                `You were on ${
                  myRole === "sherlock" ? "Sherlock's" : "Moriarty's"
                } team`
              )
            ),
            h(
              "div",
              { className: "space-y-4" },
              h(
                "div",
                { className: "bg-slate-900 rounded-lg p-4 text-left" },
                h(
                  "h3",
                  { className: "font-bold text-white mb-2" },
                  "Team Roles:"
                ),
                gameState.players.map((p) =>
                  h(
                    "div",
                    {
                      key: p.id,
                      className: "flex justify-between text-sm py-1",
                    },
                    h("span", { className: "text-slate-300" }, `${p.name}:`),
                    h(
                      "span",
                      {
                        className:
                          p.role === "sherlock"
                            ? "text-blue-400"
                            : "text-red-400",
                      },
                      p.role === "sherlock" ? "Sherlock" : "Moriarty"
                    )
                  )
                )
              ),
              // Room code display
              h(
                "div",
                { className: "bg-slate-700/50 rounded-lg p-3 mb-4" },
                h("span", { className: "text-slate-400 text-sm" }, "Room: "),
                h(
                  "span",
                  { className: "text-white font-mono font-bold" },
                  roomCode
                )
              ),

              // Error display
              error &&
                h(
                  "div",
                  {
                    className:
                      "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm mb-4",
                  },
                  error
                ),

              // Leave confirmation for host
              showLeaveConfirm &&
                isHost &&
                h(
                  "div",
                  {
                    className:
                      "bg-orange-900/50 border border-orange-500 rounded-lg p-4 mb-4",
                  },
                  h(
                    "p",
                    { className: "text-orange-200 font-bold mb-2" },
                    "âš ï¸ Are you sure?"
                  ),
                  h(
                    "p",
                    { className: "text-orange-300 text-sm mb-3" },
                    "As the host, leaving will close the room for all players."
                  ),
                  h(
                    "div",
                    { className: "flex gap-2" },
                    h(
                      "button",
                      {
                        onClick: () => setShowLeaveConfirm(false),
                        className:
                          "flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg font-bold transition-all",
                      },
                      "Cancel"
                    ),
                    h(
                      "button",
                      {
                        onClick: handleLeave,
                        disabled: isLoading,
                        className:
                          "flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-bold transition-all disabled:opacity-50",
                      },
                      isLoading ? "Leaving..." : "Yes, Leave"
                    )
                  )
                ),

              // Action buttons
              !showLeaveConfirm &&
                h(
                  "div",
                  { className: "flex gap-2" },
                  isHost &&
                    h(
                      "button",
                      {
                        onClick: handlePlayAgain,
                        disabled: isLoading,
                        className:
                          "flex-1 bg-gradient-to-r from-green-600 to-green-500 text-white py-4 rounded-lg font-bold hover:from-green-700 hover:to-green-600 transition-all disabled:opacity-50",
                      },
                      isLoading ? "Starting..." : "ðŸ”„ Play Again"
                    ),
                  h(
                    "button",
                    {
                      onClick: handleLeave,
                      disabled: isLoading,
                      className: `${
                        isHost ? "flex-1" : "w-full"
                      } bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-lg font-bold hover:from-blue-700 hover:to-blue-600 transition-all disabled:opacity-50`,
                    },
                    isLoading ? "Leaving..." : "ðŸšª Leave Room"
                  )
                ),
              !isHost &&
                h(
                  "p",
                  { className: "text-slate-400 text-sm mt-3" },
                  "ðŸ’¡ Waiting for host to start a new game..."
                )
            )
          )
        );
      }

      // ==========================================
      // MAIN APP
      // ==========================================
      function TimeBombGame() {
        const [screen, setScreen] = useState("home");
        const [roomCode, setRoomCode] = useState("");
        const [inputCode, setInputCode] = useState("");
        const [playerId, setPlayerId] = useState(null);
        const [playerName, setPlayerName] = useState("");
        const [gameState, setGameState] = useState(null);
        const [myRole, setMyRole] = useState(null);
        const [selectedWire, setSelectedWire] = useState(null);
        const [copied, setCopied] = useState(false);
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);
        const [gameLog, setGameLog] = useState([]);
        const [showLog, setShowLog] = useState(false);
        const [isReconnecting, setIsReconnecting] = useState(false);

        // Game over effect state (managed here for cutWire access)
        const [showGameOverEffect, setShowGameOverEffect] = useState(false);
        const [gameOverType, setGameOverType] = useState(null); // 'bomb' or 'defused'

        // Save session data whenever key state changes
        useEffect(() => {
          if (roomCode && playerId !== null && playerName) {
            const sessionData = {
              roomCode,
              playerId,
              playerName,
              myRole,
              timestamp: Date.now(),
            };
            sessionStorage.setItem(
              "timebomb_session",
              JSON.stringify(sessionData)
            );
          }
        }, [roomCode, playerId, playerName, myRole]);

        // Restore session on mount
        useEffect(() => {
          const savedSession = sessionStorage.getItem("timebomb_session");
          if (savedSession && !roomCode) {
            try {
              const session = JSON.parse(savedSession);
              // Only restore if session is less than 2 hours old
              if (Date.now() - session.timestamp < 2 * 60 * 60 * 1000) {
                setIsReconnecting(true);
                // Check if room still exists
                database
                  .ref(`rooms/${session.roomCode}`)
                  .once("value")
                  .then((snapshot) => {
                    const state = snapshot.val();
                    if (state && state.players) {
                      // Check if player is still in the room
                      const playerExists = state.players.some(
                        (p) => p.id === session.playerId
                      );
                      if (playerExists) {
                        setRoomCode(session.roomCode);
                        setPlayerId(session.playerId);
                        setPlayerName(session.playerName);
                        if (session.myRole) setMyRole(session.myRole);
                        setGameState(state);
                        // Set appropriate screen based on game status
                        if (state.status === "lobby") setScreen("lobby");
                        else if (state.status === "playing") {
                          setScreen("game");
                          // Get role from game state if not in session
                          if (!session.myRole) {
                            const player = state.players.find(
                              (p) => p.id === session.playerId
                            );
                            if (player && player.role) setMyRole(player.role);
                          }
                        } else if (state.status === "ended") setScreen("end");
                      } else {
                        // Player no longer in room, clear session
                        sessionStorage.removeItem("timebomb_session");
                      }
                    } else {
                      // Room no longer exists, clear session
                      sessionStorage.removeItem("timebomb_session");
                    }
                    setIsReconnecting(false);
                  })
                  .catch(() => {
                    sessionStorage.removeItem("timebomb_session");
                    setIsReconnecting(false);
                  });
              } else {
                // Session too old, clear it
                sessionStorage.removeItem("timebomb_session");
              }
            } catch (e) {
              sessionStorage.removeItem("timebomb_session");
            }
          }
        }, []);

        useEffect(() => {
          if (!roomCode) return;
          const roomRef = database.ref(`rooms/${roomCode}`);
          const handleUpdate = (snapshot) => {
            const state = snapshot.val();
            if (state) {
              setGameState(state);
              if (state.log) setGameLog(state.log);

              // Check if current player was removed from the game
              const playerStillInGame =
                state.players && state.players.some((p) => p.id === playerId);
              if (!playerStillInGame && playerId !== null) {
                // Player was removed, go back to home
                setScreen("home");
                setRoomCode("");
                setPlayerId(null);
                setGameState(null);
                setMyRole(null);
                setError("You were removed from the room.");
                return;
              }

              if (state.status === "lobby" && screen !== "lobby") {
                setScreen("lobby");
                // Reset game over effects when returning to lobby
                setShowGameOverEffect(false);
                setGameOverType(null);
              } else if (state.status === "playing" && screen !== "game") {
                setScreen("game");
                // Reset game over effects when game starts
                setShowGameOverEffect(false);
                setGameOverType(null);
                if (!myRole && playerId !== null) {
                  const player = state.players.find((p) => p.id === playerId);
                  if (player) setMyRole(player.role);
                }
              } else if (state.status === "ended" && screen !== "end")
                setScreen("end");
            } else {
              // Room was deleted (host left)
              if (screen !== "home") {
                setScreen("home");
                setRoomCode("");
                setPlayerId(null);
                setGameState(null);
                setMyRole(null);
                setError("The room was closed by the host.");
              }
            }
          };
          roomRef.on("value", handleUpdate);
          return () => roomRef.off("value", handleUpdate);
        }, [roomCode, playerId, myRole, screen]);

        const createRoom = async () => {
          if (!playerName.trim()) {
            setError("Please enter your name");
            return;
          }
          setLoading(true);
          setError("");
          const code = generateRoomCode();
          const newPlayerId = 0;
          const initialState = {
            code,
            status: "lobby",
            hostId: newPlayerId,
            playerCount: 5,
            players: [
              { id: newPlayerId, name: playerName.trim(), ready: false },
            ],
            createdAt: Date.now(),
          };
          try {
            await database.ref(`rooms/${code}`).set(initialState);
            setRoomCode(code);
            setPlayerId(newPlayerId);
            setGameState(initialState);
            setScreen("lobby");
          } catch (err) {
            console.error("Create room error:", err);
            setError("Failed to create room. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const joinRoom = async () => {
          if (!playerName.trim()) {
            setError("Please enter your name");
            return;
          }
          if (!inputCode.trim()) {
            setError("Please enter a room code");
            return;
          }
          setLoading(true);
          setError("");
          const code = inputCode.trim().toUpperCase();
          try {
            const snapshot = await database.ref(`rooms/${code}`).once("value");
            if (!snapshot.exists()) {
              setError("Room not found");
              setLoading(false);
              return;
            }
            const state = snapshot.val();
            if (state.status !== "lobby") {
              setError("Game already started");
              setLoading(false);
              return;
            }
            if (state.players.length >= state.playerCount) {
              setError("Room is full");
              setLoading(false);
              return;
            }
            const newPlayerId = Math.max(...state.players.map((p) => p.id)) + 1;
            state.players.push({
              id: newPlayerId,
              name: playerName.trim(),
              ready: false,
            });
            await database.ref(`rooms/${code}`).set(state);
            setRoomCode(code);
            setPlayerId(newPlayerId);
            setGameState(state);
            setScreen("lobby");
          } catch (err) {
            console.error("Join room error:", err);
            setError("Failed to join room. Please try again.");
          } finally {
            setLoading(false);
          }
        };

        const updatePlayerCount = async (count) => {
          if (playerId !== gameState.hostId) return;
          try {
            await database.ref(`rooms/${roomCode}/playerCount`).set(count);
          } catch (err) {
            console.error("Failed to update player count");
          }
        };

        const toggleReady = async () => {
          const playerIndex = gameState.players.findIndex(
            (p) => p.id === playerId
          );
          if (playerIndex === -1) return;
          try {
            await database
              .ref(`rooms/${roomCode}/players/${playerIndex}/ready`)
              .set(!gameState.players[playerIndex].ready);
          } catch (err) {
            console.error("Failed to toggle ready");
          }
        };

        const startGame = async () => {
          if (playerId !== gameState.hostId) return;
          if (gameState.players.length < 4) {
            setError("Need at least 4 players to start");
            return;
          }
          if (gameState.players.length !== gameState.playerCount) {
            setError(`Waiting for ${gameState.playerCount} players`);
            return;
          }
          const config = GAME_CONFIG[gameState.playerCount];
          const roles = [
            ...Array(config.sherlock).fill("sherlock"),
            ...Array(config.moriarty).fill("moriarty"),
          ].sort(() => Math.random() - 0.5);
          const wireDeck = [
            ...Array(config.defusing).fill("defusing"),
            ...Array(config.bomb).fill("bomb"),
            ...Array(config.wires).fill("safe"),
          ].sort(() => Math.random() - 0.5);
          const playersWithRoles = gameState.players.map((player, idx) => ({
            ...player,
            role: roles[idx],
            wires: wireDeck
              .slice(idx * 5, (idx + 1) * 5)
              .map((type, wireIdx) => ({
                id: `${player.id}-0-${wireIdx}`,
                type,
                revealed: false,
              })),
          }));

          const getRandomIntegerInclusive = (min, max) => {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
          };

          const newState = {
            ...gameState,
            status: "playing",
            players: playersWithRoles,
            currentPlayer: getRandomIntegerInclusive(
              0,
              gameState.players.length - 1
            ),
            round: 1,
            revealedInRound: 0,
            defusingFound: 0,
            config,
            log: [{ message: "ðŸŽ® Game started!", timestamp: Date.now() }],
          };
          try {
            await database.ref(`rooms/${roomCode}`).set(newState);
            const me = playersWithRoles.find((p) => p.id === playerId);
            if (me) setMyRole(me.role);
            setScreen("game");
          } catch (err) {
            console.error("Start game error:", err);
            setError("Failed to start game");
          }
        };

        const cutWire = async (targetPlayerId, wireId) => {
          if (gameState.players[gameState.currentPlayer].id !== playerId)
            return;
          if (targetPlayerId === playerId) return;

          // Enforce announcement requirement at game-state level
          const allAnnounced = gameState.players.every((p) => {
            const announcement =
              gameState.announcements && gameState.announcements[p.id];
            return (
              announcement &&
              announcement.round === gameState.round &&
              announcement.locked
            );
          });
          if (!allAnnounced) {
            console.error("Cannot cut wire: not all players have announced");
            return;
          }

          // Track if game will end for local effect
          let willEndGame = false;
          let endType = null;

          const newState = JSON.parse(JSON.stringify(gameState));
          const targetPlayer = newState.players.find(
            (p) => p.id === targetPlayerId
          );
          const currentPlayer = newState.players.find((p) => p.id === playerId);
          const wire = targetPlayer.wires.find((w) => w.id === wireId);
          if (wire.revealed) return;
          wire.revealed = true;
          const log = newState.log || [];
          let logMessage = `${currentPlayer.name} cut ${targetPlayer.name}'s wire: `;
          if (wire.type === "bomb") {
            logMessage += "ðŸ’£ BOMB!";
            newState.status = "ended";
            newState.winner = "moriarty";
            willEndGame = true;
            endType = "bomb";
            log.push({ message: logMessage, timestamp: Date.now() });
            log.push({
              message: "ðŸ’¥ Big Ben destroyed! Moriarty wins!",
              timestamp: Date.now(),
            });
          } else if (wire.type === "defusing") {
            newState.defusingFound += 1;
            logMessage += `âœ‚ï¸ Defusing (${newState.defusingFound}/${newState.config.defusing})`;
            log.push({ message: logMessage, timestamp: Date.now() });
            if (newState.defusingFound === newState.config.defusing) {
              newState.status = "ended";
              newState.winner = "sherlock";
              willEndGame = true;
              endType = "defused";
              log.push({
                message: "ðŸŽ‰ All defusing wires found! Sherlock wins!",
                timestamp: Date.now(),
              });
            }
          } else {
            logMessage += "âœ“ Safe wire";
            log.push({ message: logMessage, timestamp: Date.now() });
          }
          newState.log = log;
          if (newState.status !== "ended") {
            newState.revealedInRound += 1;
            if (newState.revealedInRound === newState.playerCount) {
              if (newState.round === 4) {
                newState.status = "ended";
                newState.winner = "moriarty";
                willEndGame = true;
                endType = "bomb"; // Time ran out - Moriarty wins
                log.push({
                  message: "â° 4 rounds completed. Moriarty wins!",
                  timestamp: Date.now(),
                });
              } else {
                const unrevealedWires = newState.players
                  .flatMap((p) =>
                    p.wires.filter((w) => !w.revealed).map((w) => w.type)
                  )
                  .sort(() => Math.random() - 0.5);
                const wiresPerPlayer = Math.floor(
                  unrevealedWires.length / newState.playerCount
                );
                newState.players = newState.players.map((player, idx) => ({
                  ...player,
                  wires: unrevealedWires
                    .slice(idx * wiresPerPlayer, (idx + 1) * wiresPerPlayer)
                    .map((type, wireIdx) => ({
                      id: `${player.id}-${newState.round}-${wireIdx}`,
                      type,
                      revealed: false,
                    })),
                }));
                newState.round += 1;
                newState.revealedInRound = 0;
                log.push({
                  message: `ðŸ”„ Round ${newState.round} started!`,
                  timestamp: Date.now(),
                });
              }
            } else {
              const currentPlayerIndex = newState.players.findIndex(
                (p) => p.id === targetPlayerId
              );
              newState.currentPlayer = currentPlayerIndex;
            }
          }
          try {
            // If game is ending, show effect first then update database
            if (willEndGame) {
              setGameOverType(endType);
              setShowGameOverEffect(true);
              setSelectedWire(null);

              // Delay the database update to allow effect to show
              setTimeout(async () => {
                await database.ref(`rooms/${roomCode}`).set(newState);
              }, 2000);
            } else {
              await database.ref(`rooms/${roomCode}`).set(newState);
              setSelectedWire(null);
            }
          } catch (err) {
            console.error("Cut wire error:", err);
          }
        };

        const copyRoomCode = () => {
          navigator.clipboard.writeText(roomCode);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        };

        const leaveRoom = async () => {
          try {
            if (gameState && roomCode) {
              const isHost = playerId === gameState.hostId;

              if (isHost) {
                // Host leaves: delete the entire room
                await database.ref(`rooms/${roomCode}`).remove();
              } else {
                // Non-host leaves: remove player from the room
                const updatedPlayers = gameState.players.filter(
                  (p) => p.id !== playerId
                );
                if (updatedPlayers.length > 0) {
                  await database
                    .ref(`rooms/${roomCode}/players`)
                    .set(updatedPlayers);
                } else {
                  // No players left, delete room
                  await database.ref(`rooms/${roomCode}`).remove();
                }
              }
            }
          } catch (err) {
            console.error("Leave room error:", err);
          }

          // Clear session storage
          sessionStorage.removeItem("timebomb_session");

          // Reset local state
          setScreen("home");
          setRoomCode("");
          setPlayerId(null);
          setGameState(null);
          setMyRole(null);
          setInputCode("");
          setError("");
          setGameLog([]);
          setShowGameOverEffect(false);
          setGameOverType(null);
        };

        const playAgain = async () => {
          if (playerId !== gameState.hostId) return;

          // Reset game-over effects immediately
          setShowGameOverEffect(false);
          setGameOverType(null);

          const newState = {
            code: roomCode,
            status: "lobby",
            hostId: gameState.hostId,
            playerCount: gameState.playerCount,
            players: gameState.players.map((p) => ({
              id: p.id,
              name: p.name,
              ready: false,
            })),
            createdAt: Date.now(),
            // Explicitly remove game-specific fields
            announcements: null,
            currentPlayer: null,
            round: null,
            revealedInRound: null,
            defusingFound: null,
            config: null,
            winner: null,
            log: null,
          };

          try {
            await database.ref(`rooms/${roomCode}`).set(newState);
            setMyRole(null);
            setGameLog([]);
            setSelectedWire(null);
            setScreen("lobby");
          } catch (err) {
            console.error("Play again error:", err);
            setError("Failed to restart game. Please try again.");
          }
        };

        // Show reconnecting screen
        if (isReconnecting) {
          return h(
            "div",
            {
              className:
                "min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4",
            },
            h(
              "div",
              { className: "text-center" },
              h("div", { className: "text-5xl mb-4 animate-pulse" }, "ðŸ”„"),
              h(
                "h2",
                { className: "text-2xl font-bold text-white mb-2" },
                "Reconnecting..."
              ),
              h(
                "p",
                { className: "text-slate-400" },
                "Getting you back into the game"
              )
            )
          );
        }

        if (screen === "home") {
          return h(HomeScreen, {
            playerName,
            setPlayerName,
            inputCode,
            setInputCode,
            error,
            loading,
            createRoom,
            joinRoom,
          });
        }
        if (screen === "lobby") {
          return h(LobbyScreen, {
            roomCode,
            playerId,
            gameState,
            copied,
            error,
            copyRoomCode,
            updatePlayerCount,
            toggleReady,
            startGame,
            leaveRoom,
          });
        }
        if (screen === "end") {
          return h(EndScreen, {
            gameState,
            myRole,
            playerId,
            playAgain,
            leaveRoom,
            error,
            roomCode,
          });
        }
        if (screen === "game") {
          return h(GameScreen, {
            gameState,
            playerId,
            myRole,
            selectedWire,
            setSelectedWire,
            gameLog,
            showLog,
            setShowLog,
            cutWire,
            showGameOverEffect,
            gameOverType,
          });
        }
        return null;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(h(TimeBombGame));
    </script>
  </body>
</html>
